//>>built
define("gridx/core/Core",["dojo/_base/declare","dojo/_base/array","dojo/_base/lang","dojo/_base/Deferred","dojo/DeferredList","dojo/date/locale","./model/Model","./Row","./Column","./Cell","./_Module"],function(_1,_2,_3,_4,_5,_6,_7,_8,_9,_a,_b){function _c(_d){var _e={},i;for(i in _d){_e[i]=_d[i];}return _e;};return _1("gridx.core.Core",null,{reset:function(_f){this._uninit();_f=_c(_f);this.setColumns(_f.structure);_f.columns=this._columnsById;this.store=_f.store;_f.modules=_f.modules||[];_f.modelExtensions=_f.modelExtensions||[];_f=this._checkModelExtensions(this._checkCircle(this._removeDuplicate(this._checkForced(this._normalizeModules(_f)))));this.model=new _7(_f);this._createModules(_f);},_postCreate:function(){this._preloadModules();this._deferStartup=new _4();this._loadModules(this._deferStartup).then(_3.hitch(this,this.onModulesLoaded));},onModulesLoaded:function(){},setStore:function(_10){this.store=_10;this.reset(this);this._postCreate();this._deferStartup.callback();},setColumns:function(_11){this.structure=_11;this._columns=_3.clone(_11);this._columnsById=this._configColumns(this._columns);if(this.model){this.model._cache.onSetColumns(this._columnsById);}},row:function(_12,_13){var id=_12;if(typeof id==="number"&&!_13){id=this.model.indexToId(id);}if(this.model.idToIndex(id)>=0){this._rowObj=this._rowObj||this._mixinComponent(new _8(this),"row");return _3.delegate(this._rowObj,{id:id});}return null;},column:function(_14,_15){var id=_14,c;if(typeof id==="number"&&!_15){c=this._columns[id];id=c&&c.id;}c=this._columnsById[id];if(c){this._colObj=this._colObj||this._mixinComponent(new _9(this),"column");var _16,obj={};for(_16 in c){if(this._colObj[_16]===undefined){obj[_16]=c[_16];}}return _3.delegate(this._colObj,obj);}return null;},cell:function(_17,_18,_19){var r=_17 instanceof _8?_17:this.row(_17,_19);if(r){var c=_18 instanceof _9?_18:this.column(_18,_19);if(c){this._cellObj=this._cellObj||this._mixinComponent(new _a(this),"cell");return _3.delegate(this._cellObj,{row:r,column:c});}}return null;},columnCount:function(){return this._columns.length;},rowCount:function(_1a){return this.model.size(_1a);},columns:function(_1b,_1c){_1b=_1b||0;var _1d=this._columns.length,end=_1c>=0?_1b+_1c:_1d,res=[];for(;_1b<end&&_1b<_1d;++_1b){res.push(this.column(_1b));}return this._mixinArrayUtils(res);},rows:function(_1e,_1f){_1e=_1e||0;var _20=this.model.size(),end=_1f>=0?_1e+_1f:_20,res=[];for(;_1e<end&&_1e<_20;++_1e){res.push(this.row(_1e));}return this._mixinArrayUtils(res);},_getTypeData:function(_21,_22,_23){var col=this._columnsById[_21];if(col.storePattern&&(col.dataType=="date"||col.dataType=="time")){return _6.parse(_22,col.storePattern);}return _23;},_mixinArrayUtils:function(arr){for(var f in _2){if(_3.isFunction(_2[f])){arr[f]=_3.partial(_2[f],arr);}}return arr;},_uninit:function(){for(var _24 in this._modules){var mod=this._modules[_24].mod;if(mod.getAPIPath){this._removeAPI(this,mod.getAPIPath());}mod.destroy();}if(this.model){this.model.destroy();}},_configColumns:function(_25){var cs={},c,i,len;if(_3.isArray(_25)){for(i=0,len=_25.length;i<len;++i){c=_25[i];c.index=i;c.id=c.id||String(i+1);if(c.expandField){if(!_3.isArray(c.expandField)){c.expandField=[c.expandField];}if(!(c.nestedLevel>=0)){c.nestedLevel=i;}}if(c.storePattern&&c.field&&(c.dataType=="date"||c.dataType=="time")){c.gridPattern=c.gridPattern||(!_3.isFunction(c.formatter)&&(_3.isObject(c.formatter)||typeof c.formatter=="string")&&c.formatter)||c.storePattern;var _26;if(_3.isString(c.storePattern)){_26=c.storePattern;c.storePattern={};c.storePattern[c.dataType+"Pattern"]=_26;}c.storePattern.selector=c.dataType;if(_3.isString(c.gridPattern)){_26=c.gridPattern;c.gridPattern={};c.gridPattern[c.dataType+"Pattern"]=_26;}c.gridPattern.selector=c.dataType;c.formatter=_3.partial(this._dateTimeFormatter,c.field,c.storePattern,c.gridPattern);}cs[c.id]=c;}}return cs;},_dateTimeFormatter:function(_27,_28,_29,_2a){var d=_6.parse(_2a[_27],_28);return d?_6.format(d,_29):_2a[_27];},_preloadModules:function(){var m;for(m in this._modules){m=this._modules[m];if(m.mod.preload){m.mod.preload(m.args);}}},_loadModules:function(_2b){var dl=[],m;for(m in this._modules){dl.push(this._initializeModule(_2b,m));}return new _5(dl);},_mixinAPI:function(_2c,_2d){if(_2d){for(var _2e in _2d){if(_2c[_2e]&&_3.isObject(_2c[_2e])&&!_3.isFunction(_2c[_2e])){this._mixinAPI(_2c[_2e],_2d[_2e]);}else{_2c[_2e]=_2d[_2e];}}}},_removeAPI:function(_2f,_30){if(_30){for(var _31 in _30){delete _2f[_31];}}},_mixinComponent:function(_32,_33){var _34;for(_34 in this._modules){var m=this._modules[_34],_35=m.mod[_33+"Mixin"];if(_3.isFunction(_35)){_35=_35.apply(m.mod);}_3.mixin(_32,_35||{});}return _32;},_normalizeModules:function(_36){var i,len,m,_37=_36.modules;for(i=0,len=_37.length;i<len;++i){m=_37[i];if(_3.isFunction(m)){_37[i]={moduleClass:m};}else{if(!m){console.error(["The ",(i+1-(this._coreModCount||0)),"-th declared module can NOT be found, please require it before using it"].join(""));}else{if(!_3.isFunction(m.moduleClass)){console.error(["The ",(i+1-(this._coreModCount||0)),"-th declared module has NO moduleClass, please provide it"].join(""));delete _37[i];}}}}_36.modules=_2.filter(_37,function(m){return m;});return _36;},_checkForced:function(_38){var _39=_b._modules,_3a=_38.modules,i,j,k,_3b,_3c,_3d;for(i=0;i<_3a.length;++i){_3b=_3a[i].moduleClass.prototype;_3c=(_3b.forced||[]).concat(_3b.required||[]);for(j=0;j<_3c.length;++j){_3d=_3c[j];for(k=_3a.length-1;k>=0;--k){if(_3a[k].moduleClass.prototype.name===_3d){break;}}if(k<0){if(_39[_3d]){_3a.push({moduleClass:_39[_3d]});}else{throw new Error(["Forced/Required Dependenct Module '",_3d,"' is NOT Found for '",_3b.declaredClass,"'"].join(""));}}}}return _38;},_removeDuplicate:function(_3e){var _3f=_3e.modules,i,j,_40;for(i=_3f.length-1;i>=0;--i){if(_3f[i]){_40=_3f[i].moduleClass.prototype.name;for(j=i-1;j>=0;--j){if(_3f[j]&&_3f[j].moduleClass.prototype.name===_40){delete _3f[j];}}}else{_3f.splice(i,1);}}return _3e;},_checkCircle:function(_41){var _42=_41.modules,i,j,m,_43,q,key;var _44=function(mod){var _45=mod.moduleClass.prototype;return _3.clone((_45.forced||[]).concat(_45.optional||[]));};var _46=function(_47){for(j=_42.length-1;j>=0;--j){if(_42[j].moduleClass.prototype.name===_47){return _42[j];}}return null;};for(i=_42.length-1;i>=0;--i){m=_42[i];_43=m.moduleClass.prototype.name;q=_44(m);while(q.length){key=q.shift();if(key===_43){throw new Error("Module '"+m.moduleClass.prototype.declaredClass+"' is in a dependancy circle!");}m=_46(key);if(m){q=q.concat(_44(m));}}}return _41;},_checkModelExtensions:function(_48){var _49=_48.modules,_4a=_48.modelExtensions,i,j,ext,_4b;for(i=_49.length-1;i>=0;--i){_4b=_49[i].moduleClass.prototype;if(_4b.modelExtensions){for(j=_4b.modelExtensions.length-1;j>=0;--j){ext=_4b.modelExtensions[j];if(_2.indexOf(_4a,ext)<0){_4a.push(ext);}}}}return _48;},_createModules:function(_4c){var _4d=_4c.modules,i,mod,key,m;this._modules={};for(i=0;i<_4d.length;++i){mod=_4d[i];key=mod.moduleClass.prototype.name;if(!this._modules[key]){m=this._modules[key]={args:mod};mod=m.mod=new mod.moduleClass(this,mod);mod.forced=mod.forced||[];mod.optional=mod.optional||[];mod.loaded=new _4();m.deps=mod.forced.concat(mod.optional);if(mod.getAPIPath){this._mixinAPI(this,mod.getAPIPath());}}}},_initializeModule:function(_4e,key){var m=this._modules[key];if(!m.deferred){m.deferred=m.mod.loaded;var _4f=function(){if(m.mod.load){m.mod.load(m.args,_4e);}else{m.deferred.callback();}};var _50=this._modules;var _51=_2.filter(m.deps,function(_52){return _50[_52];});(new _5(_2.map(_51,_3.hitch(this,this._initializeModule,_4e)))).then(_4f);}return m.deferred;}});});