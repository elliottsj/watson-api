//>>built
define("gridx/core/model/AsyncCache",["dojo/_base/declare","dojo/_base/array","dojo/_base/lang","dojo/_base/Deferred","dojo/DeferredList","./_Cache"],function(_1,_2,_3,_4,_5,_6){return _1("gridx.core.model.AsyncCache",_6,{isAsync:true,cacheSize:200,pageSize:100,neighborSize:50,constructor:function(_7,_8){if(isFinite(_8.cacheSize)){this.cacheSize=_8.cacheSize;}if(_8.pageSize>0&&isFinite(_8.pageSize)){this.pageSize=_8.pageSize;}if(_8.neighborSize>=0&&isFinite(_8.neighborSize)){this.neighborSize=_8.neighborSize;}},clear:function(){if(this._requests&&this._requests.length){this._toClear=true;return;}this._requests=[];this._priority=[];this._idMap={};this._indexMap=[];this._cache={};this.totalCount=-1;this._kept={};this._keptSize=0;},byIndex:function(_9){var id=this._indexMap[_9];return id===undefined?null:this._cache[id];},byId:function(id){return this._cache[id];},idToIndex:function(id){return this._idMap[id];},indexToId:function(_a){return this._indexMap[_a];},size:function(){return this.totalCount;},when:function(_b,_c){var d=_b._def=new _4();_b._name=_c.name;try{this._fetchById(_b,_c,d);}catch(e){d.errback(e);}return d;},keep:function(id){if(!this._kept[id]&&this._cache[id]){this._kept[id]=true;++this._keptSize;return true;}return false;},free:function(id){if(this._kept[id]){delete this._kept[id];--this._keptSize;}else{if(id===undefined){this._kept={};this._keptSize=0;}}},_mergePendingRequests:function(_d){var _e=function(_f,_10){if(!_10.length||!_f.length){return _f;}var _11=[];var _12=function(idx,_13){_11[idx]=_11[idx]||0;_11[idx]+=_13;};var _14=function(_15,_16){var i,r;for(i=_15.length-1;i>=0;--i){r=_15[i];_12(r.start,_16);if(r.count){_12(r.start+r.count,-_16);}}};_14(_f,1);_14(_10,2);var f=0,i,r,res=[];for(i=0;i<_11.length;++i){if(_11[i]){f+=_11[i];if(f===1){res.push({start:i});}else{if(f===3){res._overlap=true;}r=res[res.length-1];if(r&&!r.count){r.count=i-r.start;}}}}return res;};var i,req,j,ids={},_17=[];for(i=this._requests.length-1;i>=0;--i){req=this._requests[i];_d.range=_e(_d.range,req.range);if(_d.range._overlap){_17.push(req._def);}for(j=req.id.length-1;j>=0;--j){ids[req.id[j]]=true;}}_d.id=_2.filter(_d.id,function(id){return !ids[id];});if(_17.length){_d._req=new _5(_17);}this._requests.push(_d);return _d;},_finish:function(_18,_19,_1a){if(_19){_19();}this._requests.shift();if(!this.skipCacheSizeCheck&&!this._requests.length){this._checkSize();}_1a.callback();},_finishReady:function(_1b,_1c,_1d){if(_1b._req){_1b._req.then(_3.hitch(this,"_finish",_1b,_1c,_1d));}else{this._finish(_1b,_1c,_1d);}},_fetchByIndex:function(_1e,_1f,_20){_1e=this._connectRanges(this._mergePendingRequests(this._findMissingIndexes(this._mergeRanges(_1e))));if(_1e.range.length){var _21=this,i,len,_22=_1e.range.length,_23=function(){if(!--_22){_21._finishReady(_1e,_1f,_20);}};for(i=0,len=_22;i<len;++i){this._storeFetch(_1e.range[i]).then(_23,_3.hitch(_20,_20.errback));}}else{this._finishReady(_1e,_1f,_20);}},_fetchById:function(_24,_25,_26){var _27=this;var _28=function(_29,ids){_29+=ids.length;var _2a=_27._findMissingIds(_24.id);if(_2a.length){while(_27._indexMap[_29]!==undefined){++_29;}var end=_29+1;if(end<_27._indexMap.length){while(end-_29<_27.pageSize&&_27._indexMap[end]===undefined){++end;}}else{end=_29+_27.pageSize;if(_27.totalCount>=0&&end>_27.totalCount){end=_27.totalCount;}}if(_29<end){_27._storeFetch({start:_29,count:end-_29}).then(_3.partial(_28,_29),function(e){_26.errback(e);});}else{_26.errback(new Error("Required id does not exist: "+_2a));}}else{_27._fetchByIndex(_24,_25,_26);}};_28(0,[]);},_storeFetch:function(_2b){this.onBeforeFetch();console.warn("\tFETCH: [",_2b.start,", ",_2b.count,", ",_2b.count&&_2b.start+_2b.count-1,"], options:",this.options);var s=this.store,_2c=this,d=new _4();var _2d=function(_2e){var _2f=_2c.totalCount;_2c.totalCount=parseInt(_2e,10);if(_2f!==_2c.totalCount){_2c.onSizeChange(_2c.totalCount,_2f);}};var _30=function(_31){try{var i,len=_31.length,ids=[],_32=_2b.start||0;for(i=0,len;i<len;++i){ids.push(s.getIdentity(_31[i]));_2c._addRow(_2c._itemToObject(_31[i]),_32+i,ids[i],_31[i]);}_2c.onAfterFetch();d.callback(ids);}catch(e){d.errback(e);}};var _33=function(e){console.error(e);};var req=_3.mixin({},this.options||{},_2b);if(s.fetch){s.fetch(_3.mixin(req,{onBegin:_2d,onComplete:_30,onError:_33}));}else{var _34=s.query(req.query,req);_34.total.then(_2d);_34.then(_30,_33);}return d;},_mergeRanges:function(_35){var _36=[],r=_35.range,i,t,a,b,_37;while(r.length>0){a=r.pop();_37=0;for(i=r.length-1;i>=0;--i){b=r[i];if(a.start<b.start){t=b;b=a;a=t;}if(b.count){if(a.start<=b.start+b.count){if(a.count&&a.start+a.count>b.start+b.count){b.count=a.start+a.count-b.start;}else{if(!a.count){b.count=null;}}}else{continue;}}r[i]=b;_37=1;break;}if(!_37){_36.push(a);}}_35.range=_36;return _35;},_findMissingIds:function(ids){return _2.filter(ids,function(id){return this._idMap[id]===undefined;},this);},_findMissingIndexes:function(_38){var i,j,r,end,_39,_3a=[];for(i=_38.range.length-1;i>=0;--i){r=_38.range[i];end=r.count?r.start+r.count:this._indexMap.length;_39=1;for(j=r.start;j<end;++j){if(this._indexMap[j]===undefined){if(_39){_3a.push({start:j,count:1});}else{++_3a[_3a.length-1].count;}_39=0;}else{_39=1;}}if(!r.count){if(!_39){delete _3a[_3a.length-1].count;}else{if(this.totalCount<0||j<this.totalCount){_3a.push({start:j});}}}}_38.range=_3a;return _38;},_connectRanges:function(_3b){var r=_3b.range,ps=this.pageSize,ns=this.neighborSize,i,a,b;for(i=r.length-1;i>0;--i){a=r[i];b=r[i-1];if(a.count&&a.count<ps&&b.count<ps&&a.start-b.start-b.count<ns){b.count=a.start+a.count-b.start;r.splice(i,1);}}return _3b;},_addRow:function(_3c,_3d,id,_3e){this._cache[id]={data:this._formatRow(_3c),rawData:_3c,item:_3e};var _3f=this._indexMap[_3d];if(_3f===undefined){this._indexMap[_3d]=id;this._idMap[id]=_3d;this._priority.push(id);}else{if(_3f!==id){throw new Error("Fatal error of cache._addRow: different row id for same row index. new id: "+id+", old id: "+_3f+", index: "+_3d);}}},_checkSize:function(){if(this._toClear){delete this._toClear;this.clear();}var c=this.cacheSize;if(c<0){return;}c+=this._keptSize;var p=this._priority,_40=this._indexMap,_41=this._idMap,_42=this._cache;while(p.length>c){var id=p.shift();if(this._kept[id]){p.push(id);}else{delete _40[_41[id]];delete _41[id];delete _42[id];}}},_onSet:function(_43,_44){var id=this.store.getIdentity(_43);var row=this._itemToObject(_43);var _45=this._idMap[id];if(_45!==undefined){this._addRow(row,_45,id,_43);}this.onSet(id,_45,this._cache[id]);},_onNew:function(_46){var id=this.store.getIdentity(_46),idx,row;if(this.totalCount>=0){idx=this.totalCount++;this.onSizeChange(this.totalCount,this.totalCount-1);row=this._itemToObject(_46);this._addRow(row,idx,id,_46);}this.onNew(id,idx,this._cache[id]);},_onDelete:function(_47){var id=this.store.fetch?this.store.getIdentity(_47):_47,_48=id,_49=this._idMap[id];if(_49!==undefined){this._indexMap.splice(_49,1);delete this._idMap[id];delete this._cache[id];var len,i=_2.indexOf(this._priority,id);if(i>=0){this._priority.splice(i,1);}for(i=_49,len=this._indexMap.length;i<len;++i){id=this._indexMap[i];if(id!==undefined){this._idMap[id]=i;}}--this.totalCount;this.onSizeChange(this.totalCount,this.totalCount+1);}this.onDelete(_48,_49);}});});