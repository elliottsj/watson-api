//>>built
define("gridx/core/model/Mapper",["dojo/_base/declare","dojo/_base/array","dojo/_base/lang","dojo/_base/Deferred","./_Extension"],function(_1,_2,_3,_4,_5){return _1("gridx.core.model.Mapper",_5,{priority:10,pageSize:100,constructor:function(_6,_7){this.pageSize=_7.pageSize||this.pageSize;this.clear();this._mixinAPI("filter","move","hasFilter");},destroy:function(){this.inherited(arguments);this.clear();},clear:function(){this.clearFilter();this.clearMapping();},filter:function(){var _8=this.model._cmdQueue,i;for(i=_8.length-1;i>=0;--i){if(_8[i].name==="_filter"){_8.pop();}else{break;}}_8.push({scope:this,name:"_filter",args:arguments,async:true});},move:function(_9,_a,_b){if(_9>=0&&_9<Infinity&&_a>0&&_a<Infinity&&_b>=0&&_b<Infinity&&(_b<_9||_b>=_9+_a)){var _c=this.model._cmdQueue,i,_d=[],_e=0;for(i=_c.length-1;i>=0;--i){if(_c[i].name==="_mark"){_d.push(_c[i].args[0]);}else{_e=i+1;break;}}if(_d.length){var _f=_9+_a-1;var min=Math.min(_9,_b);var max=Math.max(_f,_b);var map=function(_10){if(_10>=min&&_10<=max){if(_b<_9){if(_10<_9){return _10+_a;}else{return _10+_b-_9;}}else{if(_b>_f){if(_10>_f){return _10-_a;}else{return _b-_a+_10-_9;}}}}return _10;};for(i=_d.length-1;i>=0;--i){var _11=_d[i];var ids={};for(j in _11){j=parseInt(j,10);ids[map(j)]=_11[j];delete _11[j];}for(j in ids){_11[j]=ids[j];}}}_c.splice(_e,0,{scope:this,name:"_move",args:arguments});}},hasFilter:function(){return !!_this._filterMap;},clearMapping:function(){if(this._filterMap){var i,_12=[];for(i=0;i<this._filterMap.length;++i){var idx=this.mapIndex(i);_12[idx]={id:this._filterIdMap[i],index:idx};}this.clearFilter();this._filterMap=[];for(i=0;i<_12.length;++i){if(_12[i]!==undefined){this._filterRevMap[_12[i].index]=this._filterMap.length;this._filterMap.push(_12[i].index);this._filtered[_12[i].id]=true;this._filterIdMap.push(_12[i].id);}}}this._map={};this._revMap={};},clearFilter:function(){this._filterMap=null;this._filterRevMap={};this._filtered={};this._filterIdMap=[];delete this._checker;},onStoreReorder:function(_13){this.clearMapping();if(this._filterMap){if(_13){this._refilter=true;}else{this._reFilter();}}},byIndex:function(_14){return this.inner._call("byIndex",[this.mapIndex(_14)]);},byId:function(id){return (!this._filterMap||this._filtered[id])?this.inner._call("byId",[id]):null;},indexToId:function(_15){return this._filterMap?this._filterIdMap[_15]:this.inner._call("indexToId",[this.mapIndex(_15)]);},idToIndex:function(id){if(this._filterMap){var idx=_2.indexOf(this._filterIdMap,id);return idx>=0?idx:undefined;}else{return this.mapIndex(this.inner._call("idToIndex",[id]),true);}},size:function(){return this._filterMap?this._filterMap.length:this.inner._call("size");},when:function(_16,_17){if(this._refilter){delete this._refilter;if(this._filterMap){var d=new _4(),_18=this;this._reFilter().then(function(){_18._limitSize(_16);_18._when(_16,_17).then(_3.hitch(d,d.callback),_3.hitch(d,d.errback));});return d;}}this._limitSize(_16);return this._when(_16,_17);},_filter:function(_19){var _1a=this.size();this.clearFilter();this._checker=_19;var d=new _4();if(_3.isFunction(_19)){var _1b=this,_1c=[];this.model.scan({start:0,pageSize:this.pageSize,whenScope:this,whenFunc:this._when},function(_1d,s){var i,id,row,end=s+_1d.length;for(i=s;i<end;++i){id=_1b.indexToId(i);row=_1b.byIndex(i);if(row){if(_19(row,id)){_1c.push({id:id,index:i});}}else{break;}}}).then(function(){if(_1c.length<_1b.size()){_1b._filterMap=[];for(var i=0;i<_1c.length;++i){_1b._filterMap.push(_1c[i].index);_1b._filterRevMap[_1c[i].index]=i;_1b._filtered[_1c[i].id]=true;_1b._filterIdMap.push(_1c[i].id);}_1b.model.onFiltered(_1b._filterMap,_1b._filtered);}if(_1b.size()!==_1a){_1b.onSizeChange(_1b.size(),_1a);}d.callback();});}else{if(this.size()!==_1a){this.onSizeChange(this.size(),_1a);}d.callback();}return d;},_move:function(_1e,_1f,_20){var _21=this._filterMap,_22=this._filterIdMap;if(_21){if(_20<=_21.length&&_1e+_1f<=_21.length){var _23=_20===_21.length,_24=_23?_21[_20-1]+1:_21[_20],pre=false,_25,_26,_27,_28,i,j;if(_24<_21[_1e]){pre=true;}else{if(_24<=_21[_1e+_1f-1]){return _1e;}}for(i=0;i<_1f;++i){_25=pre?_1e+i:_1e;_26=pre?_20+i:_20;_27=_21[_25];_28=this._submove(_27,1,pre?_24+i:_24);if(pre){for(j=_26;j<_25;++j){++_21[j];}}else{for(j=_25+1;j<_26;++j){--_21[j];}}var id=_22[_25];if(_23){_21.push(_28);_21.splice(_25,1);_22.push(id);_22.splice(_25,1);}else{if(pre){_21.splice(_25,1);_21.splice(_26,0,_28);_22.splice(_25,1);_22.splice(_26,0,id);}else{_21.splice(_26,0,_28);_21.splice(_25,1);_22.splice(_26,0,id);_22.splice(_25,1);}}}this._filterRevMap={};for(i=_21.length-1;i>=0;--i){this._filterRevMap[_21[i]]=i;}return pre?_20:_20-_1f;}return _1e;}return this._submove(_1e,_1f,_20);},mapIndex:function(_29,_2a){if(this._filterMap&&!_2a){_29=this._filterMap[_29];}_29=this._mapIndex(_29,_2a);if(this._filterMap&&_2a){return this._filterRevMap[_29];}else{return _29;}},_when:function(_2b,_2c){var _2d=[];_2.forEach(_2b.range,function(r){var i;if(r.count){for(i=r.start;i<r.start+r.count;++i){_2d.push({start:this.mapIndex(i),count:1});}}else{var arr=[];for(i=0;i<r.start;++i){arr[this.mapIndex(i)]=true;}for(i=arr.length-1;i>=0;--i){if(!arr[i]){_2d.push({start:i,count:1});}}_2d.push({start:arr.length});}},this);_2b.range=_2d;return this.inner._call("when",arguments);},_limitSize:function(_2e){if(this._filterMap){_2e.range=_2.filter(_2e.range,function(r){if(!r.count||r.count<0){var cnt=this._filterMap.length-r.start;r.count=cnt;return cnt>0;}return true;},this);}},_reFilter:function(){var _2f=this,_30=_3.clone(this._filtered),_31=this._checker;return this._filter(function(row,id){return _30[id];}).then(function(){_2f._checker=_31;});},_mapIndex:function(_32,_33){var idx=(_33?this._revMap:this._map)[_32];return idx===undefined?_32:idx;},_submove:function(_34,_35,_36){var _37=this.inner._call("size");if(_37>=0&&(_34>=_37||_34+_35>_37||_36>_37)){return _34;}var _38={},_39,i,map={},_3a=_34;if(_36>_34+_35){for(i=0;i<_35;++i){_38[_34+i]=_36+i-_35;}for(i=0;i<_36-_34-_35;++i){_38[_34+_35+i]=_34+i;}_3a=_36-_35;}else{if(_36<_34){for(i=0;i<_35;++i){_38[_34+i]=_36+i;}for(i=0;i<_34-_36;++i){_38[_36+i]=_36+i+_35;}_3a=_36;}else{return _3a;}}for(_39 in _38){map[_38[_39]]=this._map.hasOwnProperty(_39)?this._map[_39]:parseInt(_39,10);}for(_39 in map){if(_39==map[_39]){delete this._map[_39];delete this._revMap[_39];}else{this._map[_39]=map[_39];this._revMap[map[_39]]=parseInt(_39,10);}}return _3a;},onDelete:function(id,idx){var i,r,len,map=this._map,_3b=this._filterMap,_3c={};if(_3b){if(this._filtered[id]&&idx===undefined){idx=this._mapIndex(_3b[_2.indexOf(this._filterIdMap,id)]);}for(i=0,len=_3b.length;i<len;++i){r=this._mapIndex(_3b[i]);if(r>idx){--r;}else{if(r===idx){continue;}}_3c[this._filterIdMap[i]]=r;}}if(idx===undefined){return;}var _3d=idx,_3e=[];for(r in map){if(map[r]===idx){_3d=parseInt(r,10);}else{if(map[r]>idx){--map[r];}}}delete map[_3d];if(_3d!==idx){var min=Math.min(_3d,idx);var max=Math.max(_3d,idx);for(r=min;r<=max;++r){if(map[r]===undefined){map[r]=_3d>idx?r-1:r+1;}}}for(r in map){r=parseInt(r,10);if(r>=_3d){_3e[r]=map[r];delete map[r];}}for(i=_3d,len=_3e.length-1;i<len;++i){r=_3e[i+1];if(r!==undefined){if(i!==r){map[i]=r;}else{delete map[i];}}else{if(i+1<idx){map[i]=i+1;}else{delete map[i];}}}delete map[_3e.length-1];this._revMap={};for(r in map){this._revMap[map[r]]=parseInt(r,10);}if(_3b){var arr=[];for(r in _3c){arr[this._mapIndex(_3c[r],true)]=r;}this._filterMap=[];this._filterIdMap=[];this._filterRevMap={};for(i=0;i<arr.length;++i){if(arr[i]!==undefined){r=this._filterMap.length;this._filterMap[r]=i;this._filterRevMap[i]=r;this._filterIdMap[r]=arr[i];}}}},onNew:function(id,_3f,row){if(this._filterMap&&_3.isFunction(this._checker)&&this._checker(row,id,_3f)){this._filterRevMap[this._filterMap.length]=_3f;this._filterMap.push(_3f);_3f=this._filterIdMap.length;this._filterIdMap.push(id);this._filtered[id]=true;}},onSet:function(id,_40,row){if(this._filterMap&&_3.isFunction(this._checker)){var _41=this._filterMap,_42=this._filterRevMap,_43=this._filterIdMap;if(this._checker(row,id,_40)){if(!this._filtered[id]){this._filtered[id]=true;var idx=this._mapIndex(_40,true),i;for(i=0;i<_41.length;++i){if(_41[i]>idx){break;}}_41.splice(i,0,idx);_43.splice(i,0,id);_42[idx]=i;_40=i;}else{_40=_42[_40];}}else{if(this._filtered[id]){var _44=_42[_40];delete _42[_40];_41.splice(_44,1);_43.splice(_44,1);_40=_44;}}}}});});