//>>built
define("gridx/core/model/Marker",["dojo/_base/declare","dojo/_base/Deferred","./_Extension"],function(_1,_2,_3){return _1("gridx.core.model.Marker",_3,{priority:5,constructor:function(_4){this.clear();this._mixinAPI("isMarked","getMarkedIds","markById","markByIndex","markAll");this.connect(_4,"onFiltered","_onFiltered");_4._spTypes={};},onDelete:function(){},clear:function(){this._byId={};this._skippedIds={};},getMarkedIds:function(_5){var _6=[],id,_7=this._byId[this._initMark(_5)];if(_7){for(id in _7){_6.push(id);}}return _6;},isMarked:function(id,_8){return !!this._byId[this._initMark(_8)][id];},markById:function(id,_9,_a){_a=this._initMark(_a);var _b=this.isMarked(id,_a);if(_9&&!_b){this._addMark(id,_a);}else{if(!_9&&_b){this._removeMark(id,_a);}}if(!this._noSkipIds&&(this.model._prevCmdQueues.length||this.model._cmdQueue.length)){var _c=this._skippedIds[id]=this._skippedIds[id]||{};_c[_a]=[!!_9,this._counter++];}},markByIndex:function(_d,_e,_f){if(_d>=0&&_d<Infinity){_f=this._initMark(_f);var _10=this._findLastMarkCmdArgs();var _11=_10[_d]=_10[_d]||{};_11[_f]=[!!_e,this._counter++];this._command(_10);}},markAll:function(_12,_13){_13=this._initMark(_13);var _14=this._findLastMarkCmdArgs();_14[-1]=_14[-1]||{};_14[-1][_13]=[!!_12,this._counter++];var i;for(i in _14){i=parseInt(i,10);if(i>=0){delete _14[i][_13];}}this._command(_14);},_counter:0,onNew:function(id){this._onNewOrDelete(id);},onDelete:function(id){this._onNewOrDelete(id);},_onNewOrDelete:function(id){var _15;for(_15 in this._byId){this._removeMark(id,_15);}},_syncMark:function(_16){var _17=this.model,_18=this,i;mark=function(_19,_1a){id=_17.indexToId(_19);for(type in _1a){var _1b=_1a[type];var _1c=_18._skippedIds[id];_1c=_1c&&_1c[type];if(!_1c||_1c[1]<_1b[1]){_18.markById(id,_1b[0],type);}}};this._noSkipIds=true;if(_16[-1]){var _1d=_17.size();for(i=0;i<_1d;++i){mark(i,_16[-1]);}}for(i in _16){i=parseInt(i,10);if(i>=0){mark(i,_16[i]);}}delete this._noSkipIds;},_mark:function(_1e){var d=new _2(),_1f=[],_20=[],_21=this,i;if(_1e[-1]){_1f.push({start:0});}else{for(i in _1e){i=parseInt(i,10);if(i>=0){_20.push(i);_1f.push({start:i,count:1});}}}this.model._model._call("when",[{range:_1f,id:[]},function(){try{_21._syncMark(_1e);}catch(e){d.errback(e);}}]).then(function(){d.callback();});return d;},_initMark:function(_22){_22=_22||"select";this._byId[_22]=this._byId[_22]||{};return _22;},_addMark:function(id,_23){this._byId[this._initMark(_23)][id]=true;this.model.onMarked(id,_23);},_removeMark:function(id,_24){delete this._byId[this._initMark(_24)][id];this.model.onMarkRemoved(id,_24);},_findLastMarkCmdArgs:function(){var _25=this.model._cmdQueue,_26={},cmd=_25[_25.length-1];if(cmd&&cmd.name==="_mark"){--this._cmdCount;_25.pop();_26=cmd.args[0];}return _26;},_command:function(_27){this.model._cmdQueue.push({scope:this,name:"_mark",args:[_27],async:true});},_onFiltered:function(_28,_29){var _2a,_2b=this.model._spTypes,id;for(_2a in _2b){if(_2b[_2a]){for(id in this._byId[_2a]){if(!_29[id]){this._removeMark(id,_2a);}}}}}});});