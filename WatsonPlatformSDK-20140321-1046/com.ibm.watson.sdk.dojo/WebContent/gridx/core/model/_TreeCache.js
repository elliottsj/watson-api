//>>built
define("gridx/core/model/_TreeCache",["dojo/_base/declare","dojo/_base/Deferred","dojo/_base/array","dojo/_base/lang","dojo/DeferredList","./_Cache"],function(_1,_2,_3,_4,_5,_6){return _1(_6,{constructor:function(_7,_8){this.nested=_8.nested;this._childrenAttrs=[];var id,_9;for(id in this.columns){_9=this.columns[id];if(_9.expandField){if(this.nested){this._childrenAttrs[_9.nestedLevel+1]=_9.expandField;}else{this._childrenAttrs[0]=_9.expandField;break;}}}},clear:function(){this._struct={};this._struct[""]=[];this._cache={};this._size={};},byIndex:function(_a,_b){this._init();return this._cache[this.indexToId(_a,_b)];},byId:function(id){this._init();return this._cache[id];},idToIndex:function(id){this._init();var _c=this._struct[id],_d=_c&&_c[0];_c=this._struct[_d];var _e=_3.indexOf(_c||[],id);return _e>=0?_e-1:-1;},indexToId:function(_f,_10){this._init();var _11=this._struct[_10||""];return _11&&_11[_f+1];},treePath:function(id){this._init();var _12,_13=[];while(id!==undefined){_13.unshift(id);_12=this._struct[id];id=_12&&_12[0];}if(_13[0]!==""){return [];}else{_13.pop();return _13;}},hasChildren:function(id){var _14=this.byId(id);return _14?this._hasChildren(this.byId(id).item,this.treePath(id).length):0;},size:function(_15){this._init();var _16=this._size[_15||""];return _16>=0?_16:-1;},_init:function(){},_getChildrenAttrs:function(_17){return this._childrenAttrs[this.nested?_17:0];},_hasChildren:function(_18,_19){return !_18||_3.some(this._getChildrenAttrs(_19),function(_1a){return this.store.getValues(_18,_1a).length;},this);},_storeFetch:function(_1b,_1c,_1d){if(!_1c||this.lazyChildren){return this._fetchItems(_1b,_1c,_1d);}else{return this._fetchChildItems(_1b,_1c,_1d);}},_fetchChildItems:function(_1e,_1f,_20){var _21=[],s=this.store,_22=s.getIdentity(_1f),i,dl=[],_23=this;_3.forEach(this._getChildrenAttrs(_20),function(_24){_21=_21.concat(s.getValues(_1f,_24));});var _25=this._size[_22]=_21.length,end=Math.min(_1e.count?_1e.start+_1e.count:_25,_25),_26=function(d,_27,_28){_23._addRow(_23._itemToObject(_28),_27,s.getIdentity(_28),_28,_22);d.callback(_28);};for(i=_1e.start;i<end;++i){var d=new _2(),_29=_21[i];if(s.isItemLoaded(_29)){_26(d,i,_29);}else{s.loadItem({item:_29,onItem:_4.partial(_26,d,i)});}dl.push(d);}return _5.prototype.gatherResults(dl);},_fetchItems:function(_2a,_2b,_2c){var d=new _2(),s=this.store,_2d=_2b?s.getIdentity(_2b):"";if(this._hasChildren(_2b,_2c)){var _2e=this,_2f=_2a.start||0,req=_4.mixin({parentId:_2d},this.options||{},_2a);var _30=function(_31){_2e._size[_2d]=parseInt(_31,10);};var _32=function(_33){try{_3.forEach(_33,function(_34,i){_2e._addRow(_2e._itemToObject(_34),_2f+i,s.getIdentity(_34),_34,_2d);});d.callback(_33);}catch(e){d.errback(e);}};var _35=function(e){d.errback(e);};s.fetch(_4.mixin(req,{onBegin:_30,onComplete:_32,onError:_35}));}else{this._size[_2d]=0;d.callback([]);}return d;},_addRow:function(_36,_37,id,_38,_39){var ids=this._struct[_39||""];if(!ids){throw new Error("Fatal error of cache._addRow: parent item not loaded");}if(!ids[_37+1]){ids[_37+1]=id;}else{if(ids[_37+1]!==id){throw new Error("Fatal error of cache._addRow: different row id for same row index");}}this._cache[id]={data:this._formatRow(_36),rawData:_36,item:_38};this._struct[id]=this._struct[id]||[_39];}});});