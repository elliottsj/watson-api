//>>built
define("gridx/modules/CellDijit",["dojo/_base/declare","dojo/_base/html","dojo/_base/lang","dojo/_base/query","dojo/_base/event","dojo/_base/sniff","dojo/_base/array","dojo/keys","dijit","dijit/_WidgetBase","dijit/_TemplatedMixin","dijit/_WidgetsInTemplateMixin","../core/_Module"],function(_1,_2,_3,_4,_5,_6,_7,_8,_9,_a,_b,_c,_d){var _e=_1([_a,_b,_c],{content:"",setCellValue:null,postMixInProperties:function(){this.templateString=["<div class=\"dojoxGridxCellWidget\">",this.content,"</div>"].join("");},setValue:function(_f,_10){_4(".dojoxGridxHasGridCellValue",this.domNode).map(function(_11){return _9.byNode(_11);}).forEach(function(_12){if(_12){var _13=_2.hasClass(_12.domNode,"dojoxGridxUseStoreData");_12.set("value",_13?_10:_f);}});if(this.setCellValue){this.setCellValue(_f,_10,this);}}});return _d.registerModule(_1("gridx.modules.CellDijit",_d,{name:"cellDijit",required:["focus"],forced:["body"],getAPIPath:function(){return {cellDijit:this};},constructor:function(){this._decorators={};},load:function(){var i,col,_14=this.grid._columns;var _15=function(){return "";};for(i=_14.length-1;i>=0;--i){col=_14[i];if(col.decorator&&col.widgetsInCell){col.userDecorator=col.decorator;col.decorator=_15;col._cellWidgets=[];}}this.connect(this.grid.body,"onAfterRow","_showDijits");this.connect(this.grid.body,"onAfterCell","_showDijit");this.connect(this.grid.body,"onRender","_releaseWidgets");this._initFocus();this.loaded.callback();},destory:function(){this.inherited(arguments);var i,j,col,_16=this.grid._columns;for(i=_16.length-1;i>=0;--i){col=_16[i];if(col._cellWidgets){for(j=col._cellWidgets.length-1;j>=0;--j){col._cellWidgets[j].destroyRecursive();}delete col._cellWidgets;}}},setCellDecorator:function(_17,_18,_19,_1a){var _1b=this._decorators[_17];if(!_1b){_1b=this._decorators[_17]={};}var _1c=_1b[_18];if(!_1c){_1c=_1b[_18]={};}_1c.decorator=_19;_1c.setCellValue=_1a;_1c.widget=null;},restoreCellDecorator:function(_1d,_1e){var _1f=this._decorators[_1d];if(_1f){var _20=_1f[_1e];if(_20){if(_20.widget){var _21=_20.widget.domNode.parentNode;if(_21){_21.innerHTML=null;}window.setTimeout(function(){_20.widget.destroyRecursive();_20.widget=null;_20.decorator=null;_20.setCellValue=null;},0);}}delete _1f[_1e];}},getCellWidget:function(_22,_23){var _24=this.grid.body.getCellNode({rowId:_22,colId:_23});if(_24){var _25=_4(".dojoxGridxCellWidget",_24)[0];if(_25){return _9.byNode(_25);}}return null;},_showDijits:function(_26,_27,_28){var _29=this;var _2a=function(){var i,col,_2b,_2c,_2d=_29.grid._columns;for(i=_2d.length-1;i>=0;--i){col=_2d[i];if(col.userDecorator||_29._getSpecialCellDec(_27.rowId,col.id)){_2b=_4("[colid=\""+col.id+"\"]",_26)[0];if(_2b){_2c=_29._getCellWidget(col,_27,_28);_2b.innerHTML="";_2c.placeAt(_2b);_2c.startup();}}}};if(_6("webkit")){_2a();}else{setTimeout(_2a,0);}},_showDijit:function(_2e,_2f,col,_30){var _31=this;var _32=function(){if(col.userDecorator||_31._getSpecialCellDec(_2f.rowId,col.id)){cellWidget=_31._getCellWidget(col,_2f,_30);_2e.innerHTML="";cellWidget.placeAt(_2e);cellWidget.startup();}};if(_6("webkit")){_32();}else{setTimeout(_32,0);}},_getCellWidget:function(_33,_34,_35){var _36=this._getSpecialWidget(_33,_34,_35),_37=_35.data[_33.id],_38=_35.rawData[_33.field];if(!_36){_36=new _e({content:_33.userDecorator(),setCellValue:_33.setCellValue});_33._cellWidgets.push(_36);}_36.setValue(_37,_38);return _36;},_releaseHandler:null,_releaseWidgets:function(){if(this._releaseHandler){clearTimeout(this._releaseHandler);delete this._releaseHandler;}var _39=this;this._releaseHandler=setTimeout(function(){var bn=_39.grid.bodyNode,_3a=_39.grid._columns,i,col,j,_3b,_3c=function(_3d){while(_3d&&_3d!==bn){_3d=_3d.parentNode;}return _3d;};for(i=_3a.length-1;i>=0;--i){col=_3a[i];if(col._cellWidgets){for(j=col._cellWidgets.length-1;j>=0;--j){_3b=col._cellWidgets[j];if(!_3c(_3b.domNode)){col._cellWidgets.splice(j,1);_3b.destroyRecursive();}}}}},100);},_getSpecialCellDec:function(_3e,_3f){var _40=this._decorators[_3e];return _40&&_40[_3f];},_getSpecialWidget:function(_41,_42,_43){var _44=this._decorators[_42.rowId];if(_44){var _45=_44[_41.id];if(_45){if(!_45.widget&&_45.decorator){_45.widget=new _e({content:_45.decorator(_43.data[_41.id],_42.rowId,_42.rowIndex),setCellValue:_45.setCellValue});}return _45.widget;}}return null;},_initFocus:function(){if(this.grid.focus){this.grid.focus.registerArea({name:"celldijit",priority:1,doFocus:_3.hitch(this,"_doFocus"),doBlur:_3.hitch(this,"_doBlur"),onFocus:_3.hitch(this,"_onFocus"),onBlur:_3.hitch(this,"_endNavigate")});this.connect(this.grid,"onCellKeyPress","_onKey");}},_doFocus:function(evt,_46){if(this._navigating){var _47=this._navElems;var _48=function(){var _49=_46<0?(_47.highest||_47.last):(_47.lowest||_47.first);if(_49){_49.focus();}};if(_6("webkit")){_48();}else{setTimeout(_48,5);}return true;}return false;},_doBlur:function(evt,_4a){if(evt){var _4b=this._navElems;var _4c=_4b.lowest||_4b.first;var _4d=_4b.last||_4b.highest||_4c;var _4e=_6("ie")?evt.srcElement:evt.target;if(_4e==(_4a>0?_4d:_4c)){_5.stop(evt);this.model.when({id:this._focusRowId},function(){var _4f=this.grid.body.getRowInfo({parentId:this.model.treePath(this._focusRowId).pop(),rowIndex:this.model.idToIndex(this._focusRowId)}).visualIndex;var _50=this.grid._columnsById[this._focusColId].index;var dir=_4a>0?1:-1;var _51=this;var _52=function(r,c){return _51._isNavigable(_51.grid._columns[c].id);};this.grid.body._nextCell(_4f,_50,dir,_52).then(function(obj){_51._focusColId=_51.grid._columns[obj.c].id;var _53=_51.grid.body.getRowInfo({visualIndex:obj.r});_51._focusRowId=_51.model.indexToId(_53.rowIndex,_53.parentId);_51.grid.body._focusCellCol=obj.c;_51.grid.body._focusCellRow=obj.r;_51._beginNavigate(_51._focusRowId,_51._focusColId);_51._doFocus(null,_4a);});},this);}return false;}else{this._navigating=false;return true;}},_isNavigable:function(_54){var col=this.grid._columnsById[_54];return col&&col.navigable&&col.decorator;},_beginNavigate:function(_55,_56){if(this._isNavigable(_56)){this._navigating=true;this._focusColId=_56;this._focusRowId=_55;this._navElems=_9._getTabNavigable(this.grid.body.getCellNode({rowId:_55,colId:_56}));return true;}return false;},_endNavigate:function(){this._navigating=false;},_isFocusable:function(_57){var tag=_57.tagName.toLowerCase();return _7.indexOf(["input","textarea","button","a"],tag)>=0||_57.tabIndex>=0;},_onFocus:function(evt){var _58=evt.target;if(this._isFocusable(_58)){while(_58&&_58!==this.grid.domNode&&!_2.hasClass(_58,"dojoxGridxCell")){_58=_58.parentNode;}if(_58&&_58!==this.grid.domNode){var _59=_58.getAttribute("colid");while(_58&&!_2.hasClass(_58,"dojoxGridxRow")){_58=_58.parentNode;}if(_58){var _5a=_58.getAttribute("rowid");return this._beginNavigate(_5a,_59);}}}return false;},_onKey:function(e){var _5b=this.grid.focus;if(e.keyCode===_8.F2&&!this._navigating&&_5b.currentArea()==="body"){if(this._beginNavigate(e.rowId,e.columnId)){_5.stop(e);_5b.focusArea("celldijit");}}else{if(e.keyCode===_8.ESCAPE&&this._navigating&&_5b.currentArea()==="celldijit"){this._navigating=false;_5b.focusArea("body");}else{if(this._navigating&&e.keyCode!==_8.TAB){_5.stop(e);}}}}}));});