//>>built
define("gridx/modules/Focus",["dojo/_base/declare","dojo/_base/array","dojo/_base/connect","dojo/keys","../core/_Module","../util"],function(_1,_2,_3,_4,_5,_6){return _5.registerModule(_1("gridx.module.Focus",_5,{name:"focus",constructor:function(){this._areas={};this._tabQueue=[];this._focusNodes=[];},getAPIPath:function(){return {focus:this};},load:function(){var g=this.grid;this.batchConnect([g.domNode,"onmousedown","_onMouseDown"],[g.domNode,"onkeydown","_onTabDown"],[g.domNode,"onfocus","_focus"],[g.lastFocusNode,"onfocus","_focus"],[g,"onBlur","_doBlur"]);this.loaded.callback();},destroy:function(){this._areas=null;this._areaQueue=null;this._focusNodes=[];this._queueIdx=-1;this.inherited(arguments);},registerArea:function(_7){if(_7&&_7.name&&typeof _7.priority==="number"){if(this._areas[_7.name]){this.removeArea(_7.name);}var _8=function(){return true;};_7.doFocus=_7.doFocus||_8;_7.doBlur=_7.doBlur||_8;_7.onFocus=_7.onFocus||_8;_7.onBlur=_7.onBlur||_8;_7.connects=_7.connects||[];this._areas[_7.name]=_7;var i=_6.biSearch(this._tabQueue,function(a){return a.p-_7.priority;});if(this._tabQueue[i]&&this._tabQueue[i].p===_7.priority){this._tabQueue[i].stack.unshift(_7.name);this._focusNodes[i]=_7.focusNode||this._focusNodes[i];}else{this._tabQueue.splice(i,0,{p:_7.priority,stack:[_7.name]});this._focusNodes.splice(i,0,_7.focusNode);}}},focusArea:function(_9,_a){var _b=this._areas[_9];if(_b){var _c=this._areas[this.currentArea()];if(_c&&_c.name===_9){if(_a){_c.doFocus();}return true;}else{if(!_c||_c.doBlur()){if(_c){this.onBlurArea(_c.name);}if(_b.doFocus()){this.onFocusArea(_b.name);this._updateCurrentArea(_b);return true;}this._updateCurrentArea();}}}return false;},currentArea:function(){var a=this._tabQueue[this._queueIdx];return a?a.stack[this._stackIdx]:"";},tab:function(_d,_e){var _f=this._areas[this.currentArea()];if(!_d){return _f?_f.name:"";}var cai=this._queueIdx+_d,dir=_d>0?1:-1;if(_f){var _10=_f.doBlur(_e,_d);var _11=this._areas[_10];if(_10){this.onBlurArea(_f.name);}if(_11&&_11.doFocus(_e,_d)){this.onFocusArea(_11.name);this._updateCurrentArea(_11);return _11.name;}else{if(!_10){return _f.name;}}}for(;cai>=0&&cai<this._tabQueue.length;cai+=dir){var i,_12=this._tabQueue[cai].stack;for(i=0;i<_12.length;++i){var _13=_12[i];if(this._areas[_13].doFocus(_e,_d)){this.onFocusArea(_13);this._queueIdx=cai;this._stackIdx=i;return _13;}}}this._tabingOut=true;if(_d<0){this._queueIdx=-1;this.grid.domNode.focus();}else{this._queueIdx=this._tabQueue.length;this.grid.lastFocusNode.focus();}return "";},removeArea:function(_14){var _15=this._areas[_14];if(_15){if(this.currentArea()===_14){this._updateCurrentArea();}var i=_6.biSearch(this._tabQueue,function(a){return a.p-_15.priority;});var j,_16=this._tabQueue[i].stack;for(j=_16.length-1;j>=0;--j){if(_16[j]===_15.name){_16.splice(j,1);break;}}if(!_16.length){this._tabQueue.splice(i,1);this._focusNodes.splice(i,1);}_2.forEach(_15.connects,_3.disconnect);delete this._areas[_14];return true;}return false;},onFocusArea:function(){},onBlurArea:function(){},_queueIdx:-1,_stackIdx:0,_onTabDown:function(evt){if(evt.keyCode===_4.TAB){this.tab(evt.shiftKey?-1:1,evt);}},_onMouseDown:function(evt){var _17=evt.target,_18=this._areas[this.currentArea()];while(_17&&_17!==this.grid.domNode){var i=_2.indexOf(this._focusNodes,_17);if(i>=0){var j,_19=this._tabQueue[i].stack;for(j=0;j<_19.length;++j){var _1a=this._areas[_19[j]];if(_1a.onFocus(evt)){if(_18&&_18.name!==_1a.name){_18.onBlur(evt);this.onBlurArea(_18.name);}this.onFocusArea(_1a.name);this._queueIdx=i;this._stackIdx=j;return;}}return;}_17=_17.parentNode;}if(_17===this.grid.domNode&&_18){this._doBlur(evt,_18);}if(!_17||_17===this.grid.domNode){_6.stopEvent(evt);}},_focus:function(evt){if(this._tabingOut){this._tabingOut=false;}else{if(evt.target===this.grid.domNode){this._queueIdx=-1;this.tab(1);}else{if(evt.target===this.grid.lastFocusNode){this._queueIdx=this._tabQueue.length;this.tab(-1);}}}},_doBlur:function(evt,_1b){if(!_1b&&this.currentArea()){_1b=this._areas[this.currentArea()];}if(_1b){_1b.onBlur(evt);this.onBlurArea(_1b.name);this._updateCurrentArea();}},_updateCurrentArea:function(_1c){if(_1c){var i=this._queueIdx=_6.biSearch(this._tabQueue,function(a){return a.p-_1c.priority;});var _1d=this._tabQueue[i].stack;this._stackIdx=_2.indexOf(_1d,_1c.name);}else{this._queueIdx=null;this._stackIdx=0;}}}));});