//>>built
define("gridx/modules/NestedSort",["dojo/_base/kernel","../core/_Module","dojo/_base/declare","dojo/_base/array","dojo/_base/html","dojo/_base/event","dojo/query","dojo/i18n!../nls/NestedSorting"],function(_1,_2){_1.declare("gridx.modules.NestedSort",_2,{name:"nestedSort",forced:["header","focus"],_a11yText:{"dojoxGridDescending":"&#9662;","dojoxGridAscending":"&#9652;","dojoxGridAscendingTip":"&#1784;","dojoxGridDescendingTip":"&#1783;","dojoxGridUnsortedTip":"x"},constructor:function(){this._sortData=[];},getAPIPath:function(){return {nestedSort:this};},preload:function(_3){this._nls=_1.i18n.getLocalization("gridx","NestedSorting");if(_3.preSort){this._sortData=_3.preSort;}if(this.grid.persist){var _4=this;var d=this.grid.persist.registerAndLoad("nestedsorting",function(){return _4._sortData;});if(d){_4._sortData=d;}}this._sortData=_1.filter(this._sortData,function(d){return this.isSortable(d.colId);},this);if(this._sortData.length){this.grid.model.sort(this._sortData);}},load:function(_5){this._init();this.loaded.callback();},columnMixin:{isSorted:function(){return this.grid.nestedSorting.isSorted(this.id);},isSortable:function(){return this.grid.nestedSorting.isSortable(this.id);}},getSortData:function(){return this._sortData;},sort:function(_6){this._sortData=_1.filter(_6,function(d){return this.isSortable(d.colId);},this);this._doSort();this._updateUI();},isSorted:function(_7){return _1.some(this.grid.nestedSorting._sortData,function(d){return d.colId==_7;});},_doSort:function(){var g=this.grid,d=this._sortData;g.model.sort(d);g.body.refresh();},clear:function(){this._sortData.length=0;this._doSort();this._updateUI();},isSortable:function(_8){var _9=this.grid._columnsById[_8];return _9&&(_9.sortable||_9.sortable===undefined);},_init:function(){this.connect(this.grid.header.domNode,"onclick","_onHeaderClick");this.connect(this.grid.header.domNode,"onmouseover","_onMouseOver");this.connect(this.grid.header.domNode,"onmouseout","_onMouseOut");this._initHeader();this._initFocus();this._updateUI();},_initHeader:function(){var _a=this.grid.header.domNode.firstChild.firstChild;var _b=_a.rows[0].cells;_1.forEach(_a.rows[0].cells,function(td){var _c=_1.attr(td,"colid");if(!this.isSortable(_c)){return;}_1.create("div",{className:"dojoxGridxSortBtn dojoxGridxSortBtnNested"},td,"first");_1.create("div",{className:"dojoxGridxSortBtn dojoxGridxSortBtnSingle"},td,"first");},this);},_onHeaderClick:function(e){var _d=e.target,_e;this._markFocus(e);if(_1.hasClass(_d,"dojoxGridxSortBtn")){_e=_1.attr(_d.parentNode,"colid");}else{return;}if(_1.hasClass(_d,"dojoxGridxSortBtnSingle")){if(this._sortData.length>1){this._sortData.length=0;}var d=_1.filter(this._sortData,function(_f){return _f.colId===_e;})[0];this._sortData.length=0;if(d){this._sortData.push(d);}this._sortColumn(_e);}else{if(_1.hasClass(_d,"dojoxGridxSortBtnNested")){this._sortColumn(_e);}}_1.stopEvent(e);},_onMouseOver:function(e){_1.addClass(this.grid.header.domNode,"dojoxGridxHeaderHover");if(this.grid.autoHeight){this.grid.vLayout.reLayout();}},_onMouseOut:function(e){_1.removeClass(this.grid.header.domNode,"dojoxGridxHeaderHover");if(this.grid.autoHeight){this.grid.vLayout.reLayout();}},_sortColumn:function(_10){if(!this.isSortable(_10)){return;}var d=_1.filter(this._sortData,function(d){return d.colId===_10;})[0];if(d){if(d.descending===false){d.descending=true;}else{if(d.descending===true){var i=_1.indexOf(this._sortData,d);this._sortData.splice(i,1);}}}else{d={colId:_10,descending:false};this._sortData.push(d);}this._doSort();this._updateUI();},_updateUI:function(){_1.removeClass(this.grid.domNode,"dojoxGridxSingleSorted");_1.removeClass(this.grid.domNode,"dojoxGridxNestedSorted");var nls=this._nls;_1.query("th",this.grid.header.domNode).forEach(function(_11){var _12=_1.attr(_11,"colid");if(!this.isSortable(_12)){return;}_1.forEach(["","Desc","Asc","Main"],function(s){_1.removeClass(_11,"dojoxGridxCellSorted"+s);});var _13=_11.childNodes[0],_14=_11.childNodes[1];var _15=_1.hasClass(_1.body(),"dijit_a11y"),_16=this._a11yText;_13.title=nls.singleSort+" - "+nls.ascending;_14.title=nls.nestedSort+" - "+nls.ascending;_13.innerHTML=_15?_16.dojoxGridAscendingTip:"&nbsp;";_14.innerHTML=this._sortData.length+1+(_15?_16.ascending:"");var d=_1.filter(this._sortData,function(_17){return _17.colId===_12;})[0];this._setWaiState(_11,_12,d);if(!d){return;}_14.innerHTML=_1.indexOf(this._sortData,d)+1;_1.addClass(_11,"dojoxGridxCellSorted");if(d===this._sortData[0]){_1.addClass(_11,"dojoxGridxCellSortedMain");}var len=this._sortData.length;if(d.descending){_1.addClass(_11,"dojoxGridxCellSortedDesc");if(len===1){_13.title=nls.singleSort+" - "+nls.unsorted;if(_15){_13.innerHTML=_16.dojoxGridUnsortedTip;}}else{_14.title=nls.nestedSort+" - "+nls.unsorted;if(_15){_14.innerHTML=_16.dojoxGridUnsortedTip;}}}else{_1.addClass(_11,"dojoxGridxCellSortedAsc");if(len===1){_13.title=nls.singleSort+": "+nls.descending;if(_15){_13.innerHTML=_16.dojoxGridDescendingTip;}}else{_14.title=nls.nestedSort+" - "+nls.descending;if(_15){_14.innerHTML=_16.dojoxGridDescendingTip;}}}},this);if(this._sortData.length===1){_1.addClass(this.grid.domNode,"dojoxGridxSingleSorted");}else{if(this._sortData.length>1){_1.addClass(this.grid.domNode,"dojoxGridxNestedSorted");}}},_initFocus:function(){this._initRegions();var g=this.grid;if(g.focus){g.focus.registerArea({name:"header",priority:0,focusNode:g.header.domNode,doFocus:_1.hitch(this,"_doFocus"),doBlur:_1.hitch(this,"_blurNode"),onBlur:_1.hitch(this,"_blurNode"),connects:[this.connect(this.grid.header.domNode,"onkeypress","_onKeyPress")]});}},_doFocus:function(e){this._focusRegion(this._getCurrentRegion()||this._focusRegions[0]);return true;},_blurNode:function(e){return true;},_onKeyPress:function(e){var _18=this.grid.isLeftToRight()?_1.keys.RIGHT_ARROW:_1.keys.LEFT_ARROW;var _19=this.grid.isLeftToRight()?_1.keys.LEFT_ARROW:_1.keys.RIGHT_ARROW;switch(e.keyCode){case _19:this._focusPrevious();break;case _18:this._focusNext();break;case _1.keys.ENTER:case _1.keys.SPACE:this._onHeaderClick(e);break;}},_onBlur:function(e){this._blurRegion(e.target);},_focusNext:function(){var i=this._currRegionIdx,rs=this._focusRegions;while(rs[i+1]&&_1.style(rs[++i],"display")==="none"){}if(rs[i]){this._focusRegion(rs[i]);}},_focusPrevious:function(){var i=this._currRegionIdx,rs=this._focusRegions;while(rs[i-1]&&(_1.style(rs[--i],"display")==="none"||_1.hasClass(rs[i],"dojoxGridxSortBtn"))){}if(rs[i]){this._focusRegion(rs[i]);}},_markFocus:function(e){var _1a=e.target;var i=_1.indexOf(this._focusRegions,_1a);if(i===-1){return;}this._focusRegion(_1a);},_initRegions:function(){_1.forEach(this._nconns,_1.disconnect);this._focusRegions=[],this._nconns=[];_1.query(".dojoxGridxCell",this.grid.header.domNode).forEach(function(_1b){var _1c=_1b.childNodes;_1.forEach([2,1,0],function(i){if(!_1c[i]){return;}_1.attr(_1c[i],"tabindex","-1");this._focusRegions.push(_1c[i]);this._nconns.push(this.connect(_1c[i],"onblur","_onBlur"));},this);},this);this._currRegionIdx=-1;},_focusRegion:function(_1d){if(!_1d){return;}_1d.focus();var _1e=this._getRegionHeader(_1d);_1.addClass(_1e,"dojoxGridxCellSortFocus");if(_1.hasClass(_1d,"dojoxGridxSortNode")){_1.addClass(_1d,"dojoxGridxSortNodeFocus");}else{if(_1.hasClass(_1d,"dojoxGridxSortBtn")){_1.addClass(_1d,"dojoxGridxSortBtnFocus");}}_1.addClass(this.grid.header.domNode,"dojoxGridxHeaderFocus");this._currRegionIdx=_1.indexOf(this._focusRegions,_1d);_1d.focus();},_blurRegion:function(_1f){if(!_1f){return;}var _20=this._getRegionHeader(_1f);_1.removeClass(_20,"dojoxGridxCellSortFocus");_1.removeClass(_1f,"dojoxGridxSortNodeFocus");_1.removeClass(_1f,"dojoxGridxSortBtnFocus");_1.removeClass(this.grid.header.domNode,"dojoxGridxHeaderFocus");},_getCurrentRegion:function(){if(this._currRegionIdx===-1){return null;}return this._focusRegions[this._currRegionIdx];},_getRegionHeader:function(_21){while(_21&&!_1.hasClass(_21,"dojoxGridxCell")){_21=_21.parentNode;}return _21;},_setWaiState:function(_22,_23,_24){var col=this.grid.column(_23);var _25="Column "+col.name();var _26="none",_27="ascending";if(_24){_26=_24.descending?"descending":"ascending";_27=_24.descending?"none":"descending";}var _28=_25+" - is sorted by "+_26+". Choose to sort by "+_27;var _29=_25+" - is nested sorted by "+_26+". Choose to nested sort by "+_27;_22.childNodes[0].setAttribute("aria-label",_28);_22.childNodes[1].setAttribute("aria-label",_29);}});return gridx.modules.NestedSort;});