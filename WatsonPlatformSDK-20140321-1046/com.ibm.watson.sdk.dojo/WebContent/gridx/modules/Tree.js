//>>built
define("gridx/modules/Tree",["dojo/_base/declare","dojo/_base/html","dojo/_base/lang","dojo/_base/Deferred","dojo/DeferredList","dojo/query","dojo/keys","../core/_Module"],function(_1,_2,_3,_4,_5,_6,_7,_8){var _9=function(_a){var n=_a.firstChild;return n&&n.className&&_2.hasClass(n,"dojoxGridxTreeExpandoCell")&&!_2.hasClass(n,"dojoxGridxTreeExpandoLoading");};return _8.registerModule(_1("gridx.modules.Tree",_8,{name:"tree",constructor:function(){var _b=[];this._openInfo={"":{id:"",parentId:null,index:-1,count:0,openned:_b}};this._parentOpenInfo={"":_b};},getAPIPath:function(){return {tree:this};},load:function(_c){this.grid.domNode.setAttribute("role","treegrid");this.connect(this.grid.body,"collectCellWrapper","_createCellWrapper");this.connect(this.grid,"onCellClick","_onCellClick");this._initFocus();if(this.grid.persist){var id,_d=this.grid.persist.registerAndLoad("tree",_3.hitch(this,"_persist"));if(_d){this._openInfo=_d._openInfo;this._parentOpenInfo=_d._parentOpenInfo;for(id in this._openInfo){this._openInfo[id].openned=this._parentOpenInfo[id];}this.loaded.callback();return;}}var _e=this;this.model.when({},function(){_e._openInfo[""].count=_e.model.size();}).then(function(){_e.loaded.callback();});},nested:false,onExpand:function(id){},onCollapse:function(id){},expand:function(id,_f){var d=new _4(),_10=this;if(id&&!this._openInfo[id]){this.model.when({parentId:id,start:0,count:1},function(){_10._logicExpand(id);}).then(function(){_4.when(_f||_10._updateBody(id),function(){d.callback();_10.onExpand(id);});});}else{d.callback();}return d;},collapse:function(id,_11){var d=new _4(),_12=this;if(id&&this._openInfo[id]){this._logicCollapse(id);_4.when(_11||this._updateBody(id),function(){d.callback();_12.onCollapse(id);});}else{d.callback();}return d;},expandRecursive:function(id,_13){var _14=this,d=new _4();this.expand(id,true).then(function(){var i,dl=[],_15=_14.model.size(id);_14.model.when({start:0,parentId:id},function(){for(i=0;i<_15;++i){var _16=_14.model.indexToId(i,id);dl.push(_14.expandRecursive(_16,true));}}).then(function(){(new _5(dl)).then(function(){_4.when(_13||_14._updateBody(id),function(){d.callback();});});});});return d;},collapseRecursive:function(id,_17){var d=new _4(),_18=this._openInfo[id||""];if(_18){var i,dl=[],_19=this;for(i=_18.openned.length-1;i>=0;--i){dl.push(this.collapseRecursive(_18.openned[i],true));}(new _5(dl)).then(function(){if(id){_19.collapse(id,_17).then(function(){d.callback();});}else{if(!_17){_19._updateBody().then(function(){d.callback();});}}});}else{d.callback();}return d;},getRowInfoByVisualIndex:function(_1a,_1b){var _1c=this._openInfo[""].openned;var _1d,i;for(i=0;i<_1c.length;++i){_1d=this._openInfo[_1c[i]];if(_1d.index<_1b){_1a+=_1d.count+1;}else{break;}}var _1e={parentId:"",preCount:0};while(!_1e.found){_1e=this._getChild(_1a,_1e);}return _1e;},_getAbsoluteVisualIndex:function(_1f,_20){var _21=this._openInfo[_1f||""];if(_21){var _22=0;var _23=this._openInfo;var _24=function(_25){_22+=_20;var _26,i;for(i=0;i<_25.openned.length;++i){_26=_23[_25.openned[i]];if(_26.index<_20){_22+=_26.count;}else{break;}}_20=_25.index;if(_25.id){_22++;}return _23[_25.parentId];};while(_21){_21=_24(_21);}return _22;}return -1;},getVisualIndexByRowInfo:function(_27,_28,_29){var _2a=this._getAbsoluteVisualIndex(_27,_28);if(_2a>=0){return _2a-this._getAbsoluteVisualIndex("",_29);}},getVisualSize:function(_2b,_2c,_2d){var _2e=this._openInfo[_2d||""];if(_2e){var i,len=_2e.openned.length,_2f,_30=_2c;for(i=0;i<len;++i){_2f=this._openInfo[_2e.openned[i]];if(_2f.index>=_2b&&_2f.index<_2b+_2c){_30+=_2f.count;}}return _30;}return 0;},_parentOpenInfo:null,_openInfo:null,_createCellWrapper:function(_31,_32,_33){var col=this.grid._columnsById[_33];if(col.expandField){var _34=this.model.treePath(_32).length;if(!this.arg("nested")||col.nestedLevel===_34-1){var _35=this.model.hasChildren(_32);var _36=!!this._openInfo[_32];var pad=0,_37=18;if(!this.arg("nested")){pad=(_34-1)*_37;}var ltr=this.grid.isLeftToRight();_31.push({priority:0,wrap:function(_38){return ["<div class='dojoxGridxTreeExpandoCell ",_36?"dojoxGridxTreeExpandoCellOpen":"","' style='padding-",ltr?"left":"right",": ",pad+_37,"px;'>","<span class='dojoxGridxTreeExpandoIcon ",_35?"":"dojoxGridxTreeExpandoIconNoChildren","' ","style='margin-",ltr?"left":"right",": ",pad,"px;'>","<span class='dojoxGridxTreeExpandoInner'>",_36?"-":"+","</span></span><span class='dojoxGridxTreeExpandoContent'>",_38,"</span></span>"].join("");}});}}},_onCellClick:function(e){if(_9(e.cellNode)){var pos=_2.position(_6(".dojoxGridxTreeExpandoIcon",e.cellNode)[0]);if(e.clientX>=pos.x&&e.clientX<=pos.x+pos.w&&e.clientY>=pos.y&&e.clientY<=pos.y+pos.h){if(this._openInfo[e.rowId]){this.collapse(e.rowId);}else{this.expand(e.rowId);}}}},_updateBody:function(id){var _39=this.grid.body;if(_39){_39.updateRootRange(_39.rootStart,_39.rootCount);var _3a=_39.getRowNode({rowId:id}),n,_3b,_3c=this._openInfo[id];if(_3a){n=_6(".dojoxGridxTreeExpandoCell",_3a)[0];if(n){_3b=_6(".dojoxGridxTreeExpandoIcon",n)[0];_3b.firstChild.innerHTML="o";_2.addClass(n,"dojoxGridxTreeExpandoLoading");}}var _3d=id?this.getVisualIndexByRowInfo(this.model.treePath(id).pop(),this.model.idToIndex(id),_39.rootStart):-1;return _39.refreshVisual(_3d+1).then(function(){if(n){_3b.firstChild.innerHTML=_3c?"-":"+";_2.removeClass(n,"dojoxGridxTreeExpandoLoading");_2[_3c?"addClass":"removeClass"](n,"dojoxGridxTreeExpandoCellOpen");}});}return null;},_biSearch:function(arr,_3e){var i=0,j=arr.length,k;for(k=Math.floor((i+j)/2);i+1<j;k=Math.floor((i+j)/2)){if(_3e(arr[k])>0){j=k;}else{i=k;}}if(arr.length&&_3e(arr[i])>=0){return i;}else{return j;}},_logicExpand:function(id){if(this.model.hasChildren(id)){var _3f=this.model.treePath(id).pop();var _40=this._openInfo;var _41=this._parentOpenInfo[_3f]=this._parentOpenInfo[_3f]||[];this._parentOpenInfo[id]=this._parentOpenInfo[id]||[];if(!_40[id]){var _42=this.model.idToIndex(id);var _43=this.model.size(id);var i=this._biSearch(_41,function(_44){return _40[_44].index-_42;});if(_41[i]!==id){_41.splice(i,0,id);}for(i=this._parentOpenInfo[id].length-1;i>=0;--i){_43+=_40[this._parentOpenInfo[id][i]].count;}_40[id]={id:id,parentId:_3f,index:_42,count:_43,openned:this._parentOpenInfo[id]};var _45=_40[_3f];while(_45){_45.count+=_43;_45=_40[_45.parentId];}}}},_logicCollapse:function(id){var _46=this._openInfo[id];if(_46){var _47=this._openInfo;var _48=this.model.treePath(id).pop();var _49=this._parentOpenInfo[_48];var i=this._biSearch(_49,function(_4a){return _47[_4a].index-_46.index;});_49.splice(i,1);var _4b=_46.count;_46=_47[_48];while(_46){_46.count-=_4b;_46=_47[_46.parentId];}delete this._openInfo[id];}},_getChild:function(_4c,_4d){var _4e=this._openInfo[_4d.parentId];var i,len,_4f=_4d.preCount+_4e.index+1;var _50={found:true,visualIndex:_4c,count:1};for(i=0,len=_4e.openned.length;i<len;++i){var _51=_4e.openned[i];var _52=this._openInfo[_51];var _53=_52.index+_4f;if(_53===_4c){return _3.mixin({parentId:_4e.id,start:_52.index},_50);}else{if(_53>_4c){break;}else{if(_53+_52.count>=_4c){return {parentId:_51,preCount:_4f};}}}_4f+=_52.count;}return _3.mixin({parentId:_4e.id,start:_4c-_4f},_50);},_initFocus:function(){this.connect(this.grid,"onCellKeyPress","_onKey");},_onKey:function(e){if(e.keyCode===_7.ESCAPE){var _54=this.model.treePath(e.rowId);var _55=_54.pop();var _56=_54.length;var _57=this.grid;if(_55){var i,col,_58;for(i=_57._columns.length-1;i>=0;--i){col=_57._columns[i];if(col.expandField&&(!this.arg("nested")||col.nestedLevel===_56-1)){break;}}this.model.when({id:_55},function(){_58=_57.body.getVisualIndex({parentId:_54.pop(),rowIndex:this.model.idToIndex(_55)}).visualIndex;},this).then(function(){_57.vScroller.scrollToRow(_58).then(function(){_57.body._focusCell(null,_58,col.index);});});}}else{if(e.ctrlKey&&_9(e.cellNode)){var ltr=this.grid.isLeftToRight();if(e.keyCode===(ltr?_7.LEFT_ARROW:_7.RIGHT_ARROW)&&this._openInfo[e.rowId]){this.collapse(e.rowId);}else{if(e.keyCode===(ltr?_7.RIGHT_ARROW:_7.LEFT_ARROW)&&!this._openInfo[e.rowId]){this.expand(e.rowId);}}}}},_persist:function(){return {_openInfo:this._openInfo,_parentOpenInfo:this._parentOpenInfo};}}));});