//>>built
define("gridx/modules/VirtualVScroller",["dojo/_base/declare","dojo/_base/lang","dojo/_base/array","dojo/_base/html","dojo/_base/sniff","dojo/_base/event","dojo/_base/Deferred","dojo/query","./VScroller","../core/_Module"],function(_1,_2,_3,_4,_5,_6,_7,_8,_9,_a){return _a.registerModule(_1("gridx.modules.VirtualVScroller",_9,{name:"vscroller",getAPIPath:function(){return {vScroller:this};},constructor:function(_b,_c){if(this.grid.autoHeight){var _d=new _9(_b,_c);_2.mixin(this,_d);}else{this._scrolls=[];}},buffSize:2,lazyScroll:false,lazyScrollTimeout:50,scrollToRow:function(_e){var d=new _7(),_f=this;if(this._scrolls.length){this._scrolls[this._scrolls.length-1].then(function(){_f._subScrollToRow(_e,d);});}else{this._subScrollToRow(_e,d);}this._scrolls.push(d);return d;},_subScrollToRow:function(_10,_11){var dif=0,_12=this,bn=this.grid.bodyNode,_13=_8("[visualindex=\""+_10+"\"]",bn)[0];if(_13){if(_13.offsetTop<bn.scrollTop){dif=-this._avgRowHeight;}else{if(_13.offsetTop+_13.offsetHeight>bn.scrollTop+bn.clientHeight){dif=this._avgRowHeight;}else{this._scrolls.splice(_3.indexOf(this._scrolls,_11),1);_11.callback(true);return;}}}else{if(bn.childNodes.length){var n=bn.firstChild;while(n&&n.offsetTop<bn.scrollTop){n=n.nextSibling;}if(n){var idx=n.getAttribute("visualindex");dif=(_10>idx?1:-1)*this._avgRowHeight;}else{this._scrolls.splice(_3.indexOf(this._scrolls,_11),1);_11.callback(false);return;}}else{this._scrolls.splice(_3.indexOf(this._scrolls,_11),1);_11.callback(false);return;}}if((this.domNode.scrollTop===0&&dif<0)||(this.domNode.scrollTop>=this.domNode.scrollHeight-this.domNode.offsetHeight&&dif>0)){this._doVirtualScroll(null,true);}else{this.domNode.scrollTop+=dif/this._ratio;}setTimeout(function(){_12._subScrollToRow(_10,_11);},10);},_init:function(_14){this._rowHeight={};this._syncHeight();this.connect(this.grid,"_onResizeEnd",function(){this._doScroll(null,true);});this.connect(this.grid.bodyNode,"onmouseenter",function(){this._overBody=1;});this.connect(this.grid.bodyNode,"onmouseleave",function(){this._overBody=0;});this._doScroll(null,true);},_doVirtualScroll:function(e,_15){var dn=this.domNode,t=dn.scrollTop,_16=this.arg("buffSize"),_17=this._ratio*(t-(this._lastScrollTop||0));if(_15||_17){this._lastScrollTop=t;var _18=dn.scrollHeight-dn.offsetHeight,_19=this.grid.body,_1a=_19.visualStart,_1b=_1a+_19.visualCount,bn=this.grid.bodyNode,_1c=bn.firstChild,_1d=_1c&&_1c.offsetTop-_17,_1e=bn.lastChild,_1f=_1e&&_1e.offsetTop-_17+_1e.offsetHeight,_20=bn.scrollTop,_21=_20+bn.clientHeight,h=this._avgRowHeight,_22=Math.ceil(dn.offsetHeight/h)+2*_16,_23,end,pos,d;if(_1c&&_1d>_20&&_1d<_21){end=_19.renderStart;d=Math.ceil((_1d-_20)/h)+_16;_23=t===0?_1a:Math.max(end-d,_1a);pos="top";}else{if(_1e&&_1f>_20&&_1f<_21){_23=_19.renderStart+_19.renderCount;d=Math.ceil((_21-_1f)/h)+_16;end=t===_18?_1b:Math.min(_23+d,_1b);pos="bottom";}else{if(!_1c||_1d>_21||!_1e||_1f<_20){if(t<_18/2){_23=t===0?_1a:_1a+Math.max(Math.floor(t/h)-_16,0);end=Math.min(_23+_22,_1b);}else{end=t===_18?_1b:_1b+Math.min(_22-Math.floor((_18-t)/h),0);_23=Math.max(end-_22,_1a);}pos="clear";}else{if(_1c){if(t===0){var _24=_19.renderStart;if(_24>_1a){_23=_1a;end=_24;pos="top";}}else{if(t===_18){var _25=_19.renderStart+_19.renderCount-1;if(_25<_1b-1){_23=_25+1;end=_1b;pos="bottom";}}}}}}}if(_23<end){_19.renderRows(_23,end-_23,pos);if(t&&_23<end){var n=_8("[visualindex=\""+end+"\"]",bn)[0];if(n){_17+=n.offsetTop;}}}if(t===0){bn.scrollTop=0;}else{if(t>=_18){bn.scrollTop=bn.scrollHeight;}else{if(pos!=="clear"){bn.scrollTop+=_17;}}}}},_doScroll:function(e,_26){if(this.arg("lazyScroll")){if(this._lazyScrollHandle){window.clearTimeout(this._lazyScrollHandle);}this._lazyScrollHandle=window.setTimeout(_2.hitch(this,this._doVirtualScroll,e,_26),this.arg("lazyScrollTimeout"));}else{this._doVirtualScroll(e,_26);}},_onMouseWheel:function(e){var _27=typeof e.wheelDelta==="number"?e.wheelDelta/3:(-40*e.detail);this.domNode.scrollTop-=_27/this._ratio;_6.stop(e);},_onBodyChange:function(){this._doScroll(null,true);this._doVirtual();},_onRowCountChange:function(){this._syncHeight();this._doScroll(null,true);},_onRootRangeChange:function(){this.domNode.scrollTop=0;this._onRowCountChange();},_avgRowHeight:24,_rowHeight:null,_ratio:1,_syncHeight:function(){var h=this._avgRowHeight*this.grid.body.visualCount;var _28;if(_5("ff")){_28=17895697;}else{if(_5("webkit")){_28=134217726;}else{_28=1342177;}}if(h>_28){this._ratio=h/_28;h=_28;}this.stubNode.style.height=h+"px";},_doVirtual:function(){if(this._pointerDoVirtual){window.clearTimeout(this._pointerDoVirtual);delete this._pointerDoVirtual;}var _29=this;this._pointerDoVirtual=window.setTimeout(function(){delete _29._pointerDoVirtual;_29._updateRowHeightAndUnrenderRows();},100);},_updateRowHeightAndUnrenderRows:function(){var _2a=0,_2b=0,_2c=this.grid.body,bn=this.grid.bodyNode,top=bn.scrollTop,_2d=bn.scrollTop+bn.clientHeight;_3.forEach(bn.childNodes,function(_2e){this._rowHeight[_2e.getAttribute("rowid")]=_2e.offsetHeight;if(_2e.offsetTop>_2d){++_2b;}else{if(_2e.offsetTop+_2e.offsetHeight<top){++_2a;}}},this);_2c.unrenderRows(_2a);_2c.unrenderRows(_2b,"post");var p,h=0,c=0;for(p in this._rowHeight){h+=this._rowHeight[p];++c;}if(c){this._avgRowHeight=h/c;this._syncHeight();}}}));});