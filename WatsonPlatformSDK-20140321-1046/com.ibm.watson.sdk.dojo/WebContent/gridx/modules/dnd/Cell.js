//>>built
define("gridx/modules/dnd/Cell",["dojo/_base/declare","dojo/_base/array","dojo/_base/html","dojo/_base/lang","dojo/_base/Deferred","dojo/query","dojo/dnd/Manager","./_Base","../../core/_Module"],function(_1,_2,_3,_4,_5,_6,_7,_8,_9){return _9.registerModule(_1("gridx.modules.dnd.Cell",_8,{name:"dndCell",required:["selectCell","moveCell","body"],type:"Cell",accept:["grid/cells"],copyWhenRearrange:true,canDragIn:false,canDragOut:false,_load:function(){this.batchConnect([this.grid.body,"onRender","_onRender"],[this._selector,"onSelectionChange","_onChange"]);},_onChange:function(){if(this._checkShapeHandler){window.clearTimeout(this._checkShapeHandler);delete this._checkShapeHandler;}var _a=this;this._checkShapeHandler=window.setTimeout(function(){_5.when(_a._checkShape(),function(_b){_a._isDndShape=_b;});},0);},_onRender:function(_c,_d){var i,_e=this._selector,_f=this.model;var _10=function(_11,col){return _e.isSelected(_f.indexToId(i),col.id);};for(i=_c;i<_c+_d;++i){if(_2.some(this.grid._columns,_4.partial(_10,i))){this._onChange();return;}}},_checkShape:function(){var _12=this._selector.getSelected(),_13,r,c,i,_14=[],cr=this._columnRange={},rr=this._rowRange={},_15=this.grid._columnsById,_16=0,_17=Infinity,_18=0,_19=Infinity;if(_12.length){for(i=_12.length-1;i>=0;--i){_13=_12[i];_14.push(_13[0]);c=_15[_13[1]].index;if(c>_16){_16=c;}else{if(c<_17){_17=c;}}}cr.start=_17;cr.count=_16-_17+1;var d=new _5(),_1a=this.model;_1a.when({id:_14},function(){rr.indexToId=[];for(i=_14.length-1;i>=0;--i){r=_1a.idToIndex(_14[i]);rr.indexToId[r]=_14[i];if(r>_18){_18=r;}else{if(r<_19){_19=r;}}}rr.start=_19;rr.count=_18-_19+1;d.callback(cr.count*rr.count===_12.length);},this);return d;}return false;},_extraCheckReady:function(evt){this._handle=evt;return this._selector.isSelected(evt.rowId,evt.columnId)&&this._isDndShape;},_updateSourceSettings:function(){this.inherited(arguments);},_buildDndNodes:function(){var i,j,_1b,_1c,_1d,_1e,sb=[],_1f=this.grid._columns;for(i=this._rowRange.start,_1b=i+this._rowRange.count;i<_1b;++i){for(j=this._columnRange.start,_1c=j+this._columnRange.count;j<_1c;++j){_1d=this._rowRange.indexToId[i];_1e=_1f[j].id;sb.push("<div id='",this.grid.id,"_dnditem_cell_",_1d,"_",_1e,"' rowid='",_1d,"' rowindex='",i,"' columnid='",_1e,"' columnindex='",j,"'></div>");}}return sb.join("");},_getDndCount:function(){return this._rowRange.count*this._columnRange.count;},_createTargetAnchor:function(){var ta=this.inherited(arguments);ta.innerHTML="<div class='dojoxGridxCellBorderLeftTopDIV'></div><div class='dojoxGridxCellBorderRightBottomDIV'></div>";return ta;},_clearCellMasks:function(){_6(".dojoxGridxDnDCellMask",this.grid.bodyNode).forEach(function(_20){_3.removeClass(_20,"dojoxGridxDnDCellMask");});},_destroyUI:function(){this.inherited(arguments);this._clearCellMasks();},_beginAutoScroll:function(){},_endAutoScroll:function(){},_calcTargetAnchorPos:function(evt,_21){var _22,_23,_24,top,_25,_26,bn=this.grid.bodyNode;this._clearCellMasks();var _27;_6(".dojoxGridxRow",bn).some(function(_28){var pos=_3.position(_28);if(evt.clientY>=pos.y&&evt.clientY<=pos.y+pos.h){_27=_28;return true;}});if(_27){var _29=this._handle.rowIndex;var _2a=parseInt(_27.getAttribute("rowindex"),10);var _2b=_2a-_29+this._rowRange.start;var _2c=_2a+this._rowRange.start+this._rowRange.count-_29-1;var _2d=this.grid.body.logicalStart;var _2e=_2d+this.grid.body.logicalCount-1;if(_2b<_2d){_2c+=_2d-_2b;_2b=_2d;}else{if(_2c>_2e){_2b-=_2c-_2e;_2c=_2e;}}var _2f=_6("[rowindex='"+_2b+"']",bn)[0];var _30=_6("[rowindex='"+_2c+"']",bn)[0];_22=_21.h;top=_21.y;if(_2f&&_30){_25=_3.position(_2f);_26=_3.position(_30);_22=_26.y+_26.h-_25.y;top=_25.y;}else{if(_2f){_25=_3.position(_2f);_22=_21.y+_21.h-_25.y;top=_25.y;}else{if(_30){_26=_3.position(_30);_22=_26.y+_26.h-_21.y;}}}top-=_21.y;var _31;_6("[rowindex='"+_2a+"'] .dojoxGridxCell",bn).some(function(_32){var pos=_3.position(_32);if(evt.clientX>=pos.x&&evt.clientX<=pos.x+pos.w){_31=_32;return true;}});if(_31){var _33=this._handle.columnIndex;var _34=this.grid._columnsById[_31.getAttribute("colid")].index;var _35=_34-_33+this._columnRange.start;var _36=_34+this._columnRange.start+this._columnRange.count-_33-1;var _37=0;var _38=this.grid._columns.length-1;if(_35<_37){_36+=_37-_35;_35=_37;}else{if(_36>_38){_35-=_36-_38;_36=_38;}}var _39=this.grid._columns[_35].id;var _3a=this.grid._columns[_36].id;var _3b=_6("[rowindex='"+_2a+"'] [colid='"+_39+"']",bn)[0];var _3c=_6("[rowindex='"+_2a+"'] [colid='"+_3a+"']",bn)[0];_25=_3.position(_3b);_26=_3.position(_3c);_23=_26.x+_26.w-_25.x;_24=_25.x-_21.x;var _3d=_6(".dojoxGridxCellBorderLeftTopDIV",this._targetAnchor)[0];this._styleAnchorCorner(_3d,_2f,_2b,_39);var _3e=_6(".dojoxGridxCellBorderRightBottomDIV",this._targetAnchor)[0];this._styleAnchorCorner(_3e,_30,_2c,_3a);if(this._checkCellAccept(_2b,_35)){this._target={rowIndex:_2b,columnIndex:_35};}else{delete this._target;}return {left:_24+"px",top:top+"px",width:_23+"px",height:_22+"px"};}}delete this._target;return null;},_styleAnchorCorner:function(_3f,_40,_41,_42){if(_40){var _43=(_3.marginBox(_3f).w-_3.contentBox(_3f).w)/2;var _44=_6("[rowindex='"+_41+"'] [colid='"+_42+"']",this.grid.bodyNode)[0];if(_44){var pos=_3.position(_44);_3.style(_3f,{display:"",width:(pos.w-_43)+"px",height:(pos.h-_43)+"px"});return;}}_3.style(_3f,"display","none");},_checkCellAccept:function(_45,_46){var i,j,_47,ret=true,_48=this.grid._columns,_49=this.grid.move.cell.checkCellMoveAccept;if(_49){for(i=0;i<this._rowRange.count;++i){for(j=0;j<this._columnRange.count;++j){_47=_6("[rowindex='"+(i+_45)+"'] [colid='"+_48[j+_46].id+"']",this.grid.bodyNode)[0];if(_47&&!_49(i+this._rowRange.start,j+this._columnRange.start,i+_45,j+_46,this.grid)){_3.addClass(_47,"dojoxGridxDnDCellMask");ret=false;}}}}_7.manager().canDrop(ret);return ret;},_onDropInternal:function(_4a,_4b){if(this._target){var _4c=this.grid.move.cell;var _4d=_4c.copy;_4c.copy=_4b||this.arg("copyWhenRearrange");_4c.move({start:{row:this._rowRange.start,column:this._columnRange.start},end:{row:this._rowRange.start+this._rowRange.count-1,column:this._columnRange.start+this._columnRange.count-1}},this._target.rowIndex,this._target.columnIndex);_4c.copy=_4d;}},_onDropExternalGrid:function(_4e,_4f,_50){},_onDropExternalOther:function(_51,_52,_53){}}));});