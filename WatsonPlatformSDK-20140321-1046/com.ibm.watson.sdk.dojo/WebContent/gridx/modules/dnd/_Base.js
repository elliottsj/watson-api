//>>built
define("gridx/modules/dnd/_Base",["dojo/_base/declare","dojo/_base/lang","dojo/_base/html","dojo/_base/window","dojo/dnd/Source","dojo/dnd/Manager","../../core/_Module","./Avatar","../AutoScroll"],function(_1,_2,_3,_4,_5,_6,_7,_8){return _1(_7,{load:function(_9){this._selectStatus={};this._saveSelectStatus();this._node=_3.create("div");this._source=new _5(this.grid.domNode,{isSource:false,accept:this.arg("accept"),delay:this.arg("delay"),getSelectedNodes:function(){return [0];},getItem:_2.hitch(this,"_getItem"),checkAcceptance:_2.hitch(this,"_checkAcceptance"),onDraggingOver:_2.hitch(this,"_onDraggingOver"),onDraggingOut:_2.hitch(this,"_onDraggingOut"),onDropExternal:_2.hitch(this,"_onDropExternal"),onDropInternal:_2.hitch(this,"_onDropInternal")});this._source["dnd"+this.type]=this;this.batchConnect([this.grid,"onCellMouseOver","_checkDndReady"],[this.grid,"onCellMouseOut","_dismissDndReady"],[this.grid,"onCellMouseDown","_startDnd"],[_4.doc,"onmouseup","_endDnd"],[_4.doc,"onmousemove","_onMouseMove"]);this.subscribe("/dnd/cancel","_endDnd");this._selector=this.grid.select[this.type.toLowerCase()];this._load(_9);this.loaded.callback();},destory:function(){this.inherited(arguments);this._source.destory();_3.destroy(this._node);},getAPIPath:function(){var _a={dnd:{}};_a.dnd[this.type.toLowerCase()]=this;return _a;},delay:2,enabled:true,canDragIn:true,canDragOut:true,canRearrange:true,_load:function(){},_isOutOfGrid:function(_b){var _c=_3.position(this.grid.domNode),x=_b.clientX,y=_b.clientY;return y<_c.y||y>_c.y+_c.h||x<_c.x||x>_c.x+_c.w;},_onMouseMove:function(_d){if(this._source.isSource){var _e=this._isOutOfGrid(_d);if(!this._alreadyOut&&_e){this._alreadyOut=true;this._source.onOutEvent();}else{if(this._alreadyOut&&!_e){this._alreadyOut=false;this._source.onOverEvent();}}if(!_e&&(this._dnding||this._extDnding)){this._markTargetAnchor(_d);}}},_saveSelectStatus:function(_f){var _10,_11,_12=this.grid.select;for(_10 in _12){_11=_12[_10];if(_11&&_2.isObject(_11)){this._selectStatus[_10]=_11.arg("enabled");if(_f!==undefined){_11.enabled=_f;}}}},_loadSelectStatus:function(){var _13,_14,_15=this.grid.select;for(_13 in _15){_14=_15[_13];if(_14&&_2.isObject(_14)){_14.enabled=this._selectStatus[_13];}}},_checkDndReady:function(evt){if(!this._dndReady&&!this._dnding&&this._extraCheckReady(evt)){this._saveSelectStatus(false);this._dndReady=true;}},_dismissDndReady:function(){if(this._dndReady){this._loadSelectStatus();delete this._dndReady;}},_startDnd:function(evt){this._checkDndReady(evt);if(this._dndReady){delete this._target;this._updateSourceSettings();this._node.innerHTML=this._buildDndNodes();var m=_6.manager();this._oldStartDrag=m.startDrag;m.startDrag=_2.hitch(this,"_startDrag",evt);this._oldMakeAvatar=m.makeAvatar;m.makeAvatar=function(){return new _8(m);};m._dndInfo={type:this.type,count:this._getDndCount()};}},_updateSourceSettings:function(){this._source.isSource=true;this._source.delay=this.delay;},_endDnd:function(){var m=_6.manager();delete m._dndInfo;if(this._oldStartDrag){m.startDrag=this._oldStartDrag;delete this._oldStartDrag;}if(this._oldMakeAvatar){m.makeAvatar=this._oldMakeAvatar;delete this._oldMakeAvatar;}if(this._dndReady||this._dnding||this._extDnding){delete this._dnding;delete this._extDnding;delete this._extSource;this._destroyUI();_3.setSelectable(this.grid.domNode,true);this._loadSelectStatus();}this._source.isSource=false;},_createUI:function(){_3.addClass(_4.body(),"dojoxGridxDnDCursor");if(this.grid.autoScroll){this._beginAutoScroll();this.grid.autoScroll.enabled=true;}},_destroyUI:function(){this._unmarkTargetAnchor();_3.removeClass(_4.body(),"dojoxGridxDnDCursor");if(this.grid.autoScroll){this._endAutoScroll();this.grid.autoScroll.enabled=false;}},_createTargetAnchor:function(){return _3.create("div",{"class":"dojoxGridxDnDAnchor dojoxGridxDnDAnchor"+this.type});},_markTargetAnchor:function(evt){var _16=this._targetAnchor,_17=_3.position(this.grid.mainNode);if(!_16){_16=this._targetAnchor=this._createTargetAnchor();_16.style.display="none";this.grid.mainNode.appendChild(_16);}var pos=this._calcTargetAnchorPos(evt,_17);if(pos){_3.style(_16,pos);_16.style.display="block";}else{_16.style.display="none";}},_unmarkTargetAnchor:function(){var _18=this._targetAnchor;if(_18){_18.style.display="none";}},_startDrag:function(evt,_19,_1a,_1b){if(this._dndReady&&_19===this._source){this._oldStartDrag.call(_6.manager(),_19,this._node.childNodes,_1b);delete this._dndReady;this._dnding=true;this._createUI();this._markTargetAnchor(evt);_3.setSelectable(this.grid.domNode,false);}},_getItem:function(id){return {type:this.arg("accept"),data:id};},_checkAcceptance:function(_1c){var res=_5.prototype.checkAcceptance.apply(this._source,arguments);if(res){if(_1c[this.name]){var g=_1c[this.name].grid;if((g===this.grid&&!this.arg("canRearrange"))||(g!==this.grid&&(!this.arg("canDragIn")||!_1c[this.name].arg("canDragOut")))){return false;}else{if(g!==this.grid){this._sourceGrid=g;this._extDnding=true;}}}else{return this._checkExternalSourceAccept&&this._checkExternalSourceAccept(_1c);}}return res;},_onDraggingOver:function(){if(this._dnding||this._extDnding){this._createUI();}},_onDraggingOut:function(){if(this._dnding||this._extDnding){this._destroyUI();}},_onDropExternal:function(_1d,_1e,_1f){if(this._target!==undefined){if(_1d[this.name]){this._onDropExternalGrid(_1d,_1e,_1f);}else{this._onDropExternalOther(_1d,_1e,_1f);}}}});});