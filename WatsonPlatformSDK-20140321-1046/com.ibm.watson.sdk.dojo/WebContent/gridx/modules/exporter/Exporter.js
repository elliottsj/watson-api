//>>built
define("gridx/modules/exporter/Exporter",["dojo/_base/declare","dojo/_base/lang","../../core/_Module","dojo/_base/Deferred","dojo/_base/array"],function(_1,_2,_3,_4,_5){return _3.registerModule(_1("gridx.modules.exporter.Exporter",_3,{name:"exporter",getAPIPath:function(){return {"exporter":this};},load:function(_6,_7){},_export:function(_8,_9){var d=new _4(),g=this.grid,_a=this.model,_b=this._getColumns(_8),_c=_8.progressStep||10,_d=!!_8.includeHeader;try{if(_d&&false!==_9.beforeHeader(_8,{columnIds:_b})){_5.forEach(_b,function(_e){_9.handleHeaderCell(_8,{columnId:_e});});_9.afterHeader(_8,{columnIds:_b});}if(false!==_9.beforeBody(_8)){if(_8.selectedOnly&&g.select){var _f,_10=[],_11=[],_12={},_13,_14=[],i;if(g.select.cell&&g.select.cell.getSelected().length>0){_f=g.select.cell.getSelected();_5.forEach(_f,function(id){if(_5.indexOf(_10,id[0])<0){_10.push(id[0]);_12[id[0]]=[];_5.forEach(_f,function(i){if(i[0]==id[0]&&_5.indexOf(_12[id[0]],i[1])<0){_12[id[0]].push(i[1]);}});}});_a.when({id:_10},function(){_10.sort(function(a,b){return _a.idToIndex(a)-_a.idToIndex(b);});for(i=0;i<_10.length;i+=_c){_14=_10.slice(i,i+_c);this._exportProgress(_8,_9,_14,_b,_12);d.progress(i/_10.length);}},this);}else{if(g.select.row&&g.select.row.getSelected().length>0){_10=g.select.row.getSelected();_a.when({id:_10},function(){_10.sort(function(a,b){return _a.idToIndex(a)-_a.idToIndex(b);});for(i=0;i<_10.length;i+=_c){_14=_10.slice(i,i+_c);this._exportProgress(_8,_9,_14,_b);d.progress(i/_10.length);}},this);}else{if(g.select.column&&g.select.column.getSelected().length>0){var _15;for(i=0;i<g.rowCount();i+=_c){_a.when({start:i,count:_c},function(){_14=[];for(_15=i;_15<i+_c;_15++){_14.push(_a.indexToId(_15));}this._exportProgress(_8,_9,_14,_b);d.progress(i/g.rowCount());},this);}}}}}else{var _16=_8.start||0,_17=_8.count||g.rowCount();var _15;for(i=_16;i<_16+_17;i+=_c){_a.when({start:i,count:_c},function(){_14=[];for(_15=i;_15<i+_c&&_15<_16+_17;_15++){_14.push(_a.indexToId(_15));}this._exportProgress(_8,_9,_14,_b);d.progress(i/g.rowCount());},this);}}_9.afterBody(_8,{columnIds:_b});}d.callback(_9.getResult());}catch(e){d.errback(new Error(e));}return d;},_exportProgress:function(_18,_19,_1a,_1b,_1c){var g=this.grid,_1d=g.model,_1e,_1f=_2.isFunction(_18.filter)?_18.filter:function(){return true;},fmt=function(_20,_21){if(_2.isFunction(_18.formatter)){return _18.formatter(g.cell(_21,_20,true))||"";}else{if(_18.useStoreData){var _22=g._columnsById[_20].field;return _22?_1d.byId(_21).rawData[_22]:"";}else{return _1d.byId(_21).data[_20]||"";}}};if(false!==_19.beforeProgress(_18,{columnIds:_1b,rowIds:_1a})){_5.forEach(_1a,function(_23){if(_1f(_23)&&false!==_19.beforeRow(_18,{columnIds:_1b,rowId:_23})){_5.forEach(_1b,function(c){_1e={columnId:c,rowId:_23};_1e.data=!_1c||_5.indexOf(_1c[_23],c)>-1?fmt(c,_23):"";_19.handleCell(_18,_1e);});_19.afterRow(_18,{columnIds:_1b,rowId:_23});}});_19.afterProgress(_18,{columnIds:_1b,rowIds:_1a});}},_getColumns:function(_24){var g=this.grid,_25=[],i;if(_24.selectedOnly&&g.select){if(g.select.row&&g.select.row.getSelected().length>0){_5.forEach(g._columns,function(c){_25.push(c.id);});}else{if(g.select.column&&g.select.column.getSelected().length>0){_25=g.select.column.getSelected();}else{if(g.select.cell&&g.select.cell.getSelected().length>0){_5.forEach(g.select.cell.getSelected(),function(_26){if(_5.indexOf(_25,_26[1])<0){_25.push(_26[1]);}});}}}}else{if(_2.isArray(_24.columns)&&_24.columns.length>0){for(i=_24.columns.length;i>=0;i--){if(_24.columns[i]&&g._columnsById[_24.columns[i]]){_25.push(_24.columns[i]);}}if(_25.length<1){_5.forEach(g._columns,function(c){_25.push(c.id);});}}else{_5.forEach(g._columns,function(c){_25.push(c.id);});}}return _25.sort(function(a,b){return g._columnsById[a].index-g._columnsById[b].index;});}}));});