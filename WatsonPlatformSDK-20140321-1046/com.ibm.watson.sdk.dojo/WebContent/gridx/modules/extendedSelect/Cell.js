//>>built
define("gridx/modules/extendedSelect/Cell",["dojo/_base/declare","dojo/_base/array","dojo/_base/query","dojo/_base/html","dojo/_base/lang","dojo/_base/Deferred","dojo/_base/sniff","dojo/mouse","dojo/keys","../../core/_Module","./_RowCellBase"],function(_1,_2,_3,_4,_5,_6,_7,_8,_9,_a,_b){var _c=function(_d,_e,_f,_10){return {rid:_d,r:_e,cid:_f,c:_10};};return _a.registerModule(_1("gridx.modules.extendedSelect.Cell",_b,{name:"selectCell",cellMixin:{select:function(){this.grid.select.cell.selectByIndex(this.row.index(),this.column.index());return this;},deselect:function(){this.grid.select.cell.deselectByIndex(this.row.index(),this.column.index());return this;},isSelected:function(){return this.grid.select.cell.isSelected(this.row.id,this.column.id);}},getSelected:function(){var res=[];_2.forEach(this.grid._columns,function(col){var ids=this.model.getMarkedIds(this._getMarkType(col.id));res.push.apply(res,_2.map(ids,function(rid){return [rid,col.id];}));},this);return res;},isSelected:function(_11,_12){return this.model.isMarked(_11,this._getMarkType(_12));},_type:"cell",_markTypePrefix:"select_",_getMarkType:function(_13){var _14=this._markTypePrefix+_13;this.model._spTypes[_14]=1;return _14;},_markById:function(_15,_16){if(!_5.isArrayLike(_15[0])){_15=[_15];}var _17=this.grid._columnsById,_18=this.model;_2.forEach(_15,function(_19){var _1a=_19[0],_1b=_19[1];if(_1a&&_17[_1b]){_18.markById(_1a,_16,this._getMarkType(_1b));}},this);},_markByIndex:function(_1c,_1d){if(!_5.isArrayLike(_1c[0])){_1c=[_1c];}_1c=_2.filter(_1c,function(arg){if(_5.isArrayLike(arg)&&arg.length>=2&&arg[0]>=0&&arg[0]<Infinity&&arg[1]>=0&&arg[1]<Infinity){if(arg.length>=4&&arg[2]>=0&&arg[2]<Infinity&&arg[3]>=0&&arg[3]<Infinity){arg._range=true;}return true;}});var i,j,col,_1e,_1f=this.grid._columns,_20=this.grid.body,_21=this;_2.forEach(_1c,function(arg){if(arg._range){var a=Math.min(arg[0],arg[2]);var b=Math.max(arg[0],arg[2]);var n=b-a+1;var c1=Math.min(arg[1],arg[3]);var c2=Math.max(arg[1],arg[3]);for(i=c1;i<=c2;++i){col=_1f[i];if(col){a=_20.getRowInfo({visualIndex:a}).rowIndex;_1e=this._getMarkType(col.id);for(j=0;j<n;++j){this.model.markByIndex(j,_1d,_1e);}}}}else{col=_1f[arg[1]];if(col){i=_20.getRowInfo({visualIndex:arg[0]}).rowIndex;this.model.markByIndex(i,_1d,this._getMarkType(col.id));}}},this);return this.model.when();},_markAll:function(_22,_23){if(_23){_3(".dojoxGridxCell",this.grid.bodyNode).forEach(function(_24){_4.addClass(_24,"dojoxGridxCellSelected");});}else{_3(".dojoxGridxCellSelected",this.grid.bodyNode).forEach(function(_25){_4.removeClass(_25,"dojoxGridxCellSelected");});}_2.forEach(this.grid._columns,function(col){this.model.markAll(_23,this._getMarkType(col.id));},this);return this.model.when();},_init:function(){this.inherited(arguments);this.batchConnect([this.grid,"onCellMouseDown",function(e){if(_8.isLeft(e)){this._start(_c(e.rowId,e.visualIndex,e.columnId,e.columnIndex),e.ctrlKey,e.shiftKey);}}],[this.grid,"onCellMouseOver",function(e){this._highlight(_c(e.rowId,e.visualIndex,e.columnId,e.columnIndex));}],[this.grid,_7("ff")<4?"onCellKeyUp":"onCellKeyDown",function(e){if(e.keyCode===_9.SPACE){this._start(_c(e.rowId,e.visualIndex,e.columnId,e.columnIndex),e.ctrlKey,e.shiftKey);this._end();}}]);},_onRender:function(_26,_27){var i,end=_26+_27;for(i=0;i<this.grid._columns.length;++i){var cid=this.grid._columns[i].id;var _28=this._getMarkType(cid);for(j=_26;j<end;++j){var rid=this._getRowIdByVisualIndex(j);if(this.model.isMarked(rid,_28)||(this._selecting&&this._toSelect&&this._inRange(i,this._startItem.c,this._currentItem.c,true)&&this._inRange(j,this._startItem.r,this._currentItem.r,true))){var _29=_3("[visualindex=\""+j+"\"] [colid=\""+cid+"\"]",this.grid.bodyNode)[0];_4.addClass(_29,"dojoxGridxCellSelected");}}}},_onMark:function(_2a,id,_2b){if(!this._marking&&_2b.indexOf(this._markTypePrefix)===0){var _2c=_3("[rowid=\""+id+"\"]",this.grid.bodyNode)[0];if(_2c){var cid=_2b.substr(this._markTypePrefix.length);var _2d=_3("[colid=\""+cid+"\"]",_2c)[0];if(_2d){_4[_2a?"addClass":"removeClass"](_2d,"dojoxGridxCellSelected");}}}},_onMoveToCell:function(_2e,_2f,e){if(e.shiftKey){var rid=this._getRowIdByVisualIndex(_2e);var cid=this.grid._columns[_2f].id;this._start(_c(rid,_2e,cid,_2f),e.ctrlKey,true);this._end();}},_isSelected:function(_30){if(!_30.rid){_30.rid=this._getRowIdByVisualIndex(_30.r);}if(this._isRange){var _31=this._refSelectedIds[_30.cid];return _31&&_2.indexOf(_31,_30.rid)>=0;}else{return this.model.isMarked(_30.rid,this._getMarkType(_30.cid));}},_highlight:function(_32){if(this._selecting){var _33=this._currentItem;if(_33===null){this._highlightSingle(_32,true);}else{var _34=this;var _35=this._startItem;var _36=function(_37,to,_38){var _39=to.c>_37.c?1:-1,_3a=to.r>_37.r?1:-1,i,j,_3b={};if(!_38){for(j=_37.r,p=to.r+_3a;j!=p;j+=_3a){_3b[j]=_34.model.indexToId(j);}}for(i=_37.c,q=to.c+_39;i!=q;i+=_39){var cid=_34.grid._columns[i].id;for(j=_37.r,p=to.r+_3a;j!=p;j+=_3a){_34._highlightSingle(_c(_3b[j],j,cid,i),_38);}}};if(this._inRange(_32.r,_35.r,_33.r)||this._inRange(_32.c,_35.c,_33.c)||this._inRange(_35.r,_32.r,_33.r)||this._inRange(_35.c,_32.c,_33.c)){_36(_35,_33,false);}_36(_35,_32,true);this._focus(_32);}this._currentItem=_32;}},_doHighlight:function(_3c,_3d){var i,j,_3e=this.grid.bodyNode.childNodes;for(i=_3e.length-1;i>=0;--i){if(_3e[i].getAttribute("visualindex")==_3c.r){var _3f=_3e[i].getElementsByTagName("td");for(j=_3f.length-1;j>=0;--j){if(_3f[j].getAttribute("colid")==_3c.cid){_4[_3d?"addClass":"removeClass"](_3f[j],"dojoxGridxCellSelected");return;}}return;}}},_focus:function(_40){if(this.grid.focus){this.grid.body._focusCell(null,_40.r,_40.c);}},_getSelectedIds:function(){var res={};_2.forEach(this.grid._columns,function(col){var ids=this.model.getMarkedIds(this._getMarkType(col.id));if(ids.length){res[col.id]=ids;}},this);return res;},_beginAutoScroll:function(){},_endAutoScroll:function(){},_addToSelected:function(_41,end,_42){if(!this._isRange){this._refSelectedIds=this._getSelectedIds();}var a,b,_43,i,j,_44=[],_45=this,d=new _6();if(this._isRange){if(this._inRange(end.r,_41.r,this._lastEndItem.r)){a=Math.min(end.r,this._lastEndItem.r);b=Math.max(end.r,this._lastEndItem.r);_44.push({start:a+1,count:b-a,columnStart:_41.c,columnEnd:this._lastEndItem.c});}if(this._inRange(end.c,_41.c,this._lastEndItem.c)){_43=end.c<this._lastEndItem.c?1:-1;a=Math.min(_41.r,end.r);b=Math.max(_41.r,end.r);_44.push({start:a,count:b-a+1,columnStart:end.c+_43,columnEnd:this._lastEndItem.c});}}_43=_41.c<end.c?1:-1;for(i=_41.c;i!=end.c+_43;i+=_43){var cid=this.grid._columns[i].id;a=Math.min(_41.r,end.r);b=Math.max(_41.r,end.r);var _46=this._getMarkType(cid);for(j=a;j<=b;++j){this.model.markByIndex(j,_42,_46);}}if(_44.length){this.model.when(_44,function(){var i,j,k,_47;for(i=0;i<_44.length;++i){_47=_44[i];var _48=_47.columnStart<_47.columnEnd?1:-1;for(j=_47.columnStart;j!=_47.columnEnd+_48;j+=_48){var cid=this.grid._columns[j].id;var _49=this._getMarkType(cid);var _4a=this._refSelectedIds[cid];for(k=_47.start;k<_47.start+_47.count;++k){var rid=this.model.indexToId(k);var _4b=_4a&&_4a[rid];this.model.markById(rid,_4b,_49);}}}},this).then(function(){_45.model.when().then(function(){d.callback();});});}else{this.model.when().then(function(){d.callback();});}return d;}}));});