//>>built
define("idx/gridx/core/model/extensions/Mark",["dojo/_base/declare","dojo/_base/array","../_Extension"],function(_1,_2,_3){return _1(_3,{name:"move",priority:5,constructor:function(_4){var t=this;t.mixed="mixed";t.states={0:false,1:t.mixed,2:true};t.clear();t._mixinAPI("getMark","getMarkedIds","markById","markByIndex","clearMark","treeMarkMode");t.aspect(_4,"_msg","_receiveMsg");t.aspect(_4._cache,"onLoadRow","_onLoadRow");t.aspect(_4,"setStore","clear");_4.onMarkChange=function(){};_4._spTypes={};},clear:function(){this._byId={};this._last={};this._lazy={};this._tree={};},clearMark:function(_5){this._byId[this._initMark(_5)]={};},getMarkedIds:function(_6,_7){var t=this,_8=[],id,tp=t._initMark(_6),_9=t._byId[tp];if(_9){for(id in _9){if(_7||_9[id]==2){_8.push(id);}}}return _8;},isMarked:function(id,_a){_a=this._initMark(_a);var _b=this._byId[_a][id];return _b==2;},isPartialMarked:function(id,_c){return this._byId[this._initMark(_c)][id]==1;},getMark:function(id,_d){var m=this._byId[this._initMark(_d)][id]||0;return {0:false,1:this.mixed,2:true}[m];},markById:function(id,_e,_f){this._cmd(id,_e,_f,1);},markByIndex:function(_10,_11,_12,_13){if(_10>=0&&_10<Infinity){this._cmd(_10,_11,_12,0,_13);}},treeMarkMode:function(_14,_15){_14=this._initMark(_14);var tm=this._tree;return _15===undefined?tm[_14]:(tm[_14]=_15);},_cmdMark:function(){var t=this,_16=arguments,_17=[],m=t.model._model;_2.forEach(_16,function(arg){if(!arg[3]){_17.push({start:arg[0],count:1});}});return m._call("when",[{id:[],range:_17},function(){_2.forEach(_16,function(arg){var id=arg[3]?arg[0]:m._call("indexToId",[arg[0],arg[4]]),_18=arg[1],_19=t._initMark(arg[2]);if(_18===t.mixed){_18=1;}else{if(_18){_18=2;}else{_18=0;}}t._mark(id,_18,_19);});}]);},_onDelete:function(id,_1a,_1b){var t=this,tp,_1c=t._byId,_1d=t._last,_1e=t._lazy;for(tp in _1c){tp=t._initMark(tp);delete _1c[tp][id];delete _1d[tp][id];delete _1e[tp][id];if(_1b){t._updateParents(_1b,tp);}}t.onDelete.apply(t,arguments);},_initMark:function(_1f){var t=this,c=t._byId,s=t._last,z=t._lazy,tp=_1f||"select";c[tp]=c[tp]||{};z[tp]=z[tp]||{};s[tp]=s[tp]||{};return tp;},_cmd:function(){this.model._addCmd({name:"_cmdMark",scope:this,args:arguments,async:1});},_receiveMsg:function(msg,_20){if(msg=="filter"){var t=this,tp,id,sp=t.model._spTypes;for(tp in sp){if(sp[tp]){for(id in t._byId[tp]){if(_2.indexOf(_20,id)<0){t._doMark(id,tp,0,0,1);}}}}}},_mark:function(id,_21,_22){var t=this,tp=t._initMark(_22),_23=t._byId[tp][id]||0;if(t.model.isId(id)&&_23!=_21){t._doMark(id,tp,_21);}},_onLoadRow:function(id){var t=this,m=t.model,mm=m._model,_24=t._lazy,_25,lz,_26,pid=mm._call("treePath",[id]).pop();if(m.isId(pid)){for(_25 in _24){lz=_24[_25];_26=lz[pid];if(typeof _26=="number"){_26=lz[pid]={toMark:_26,count:mm._call("size",[pid])};}if(_26){--_26.count;if(!_26.count){delete lz[pid];}t._doMark(id,_25,_26.toMark,1);}}}},_fireEvent:function(id,_27,_28,_29){var t=this,m=t.model;if(_28!=_29){if(!_28){delete t._byId[_27][id];}m.onMarkChange(id,t.states[_28||0],t.states[_29||0],_27);}},_updateParents:function(_2a,_2b,_2c){var t=this,mm=t.model._model,_2d=t._byId[_2b],_2e=t._last[_2b];for(var i=_2a.length-1;i>0;--i){var pid=_2a[i],_2f=_2d[pid],_30=mm._call("children",[pid]),_31=_2.filter(_30,function(_32){return _2e[_32]=_2d[_32];}).length,_33=_2.filter(_30,function(_34){return _2d[_34]==2;}).length;if(_33==_30.length&&_2f!=2){_2d[pid]=2;}else{if(!_31&&_2f){delete _2d[pid];}else{if(_31&&_33<_30.length&&_2f!=1){_2d[pid]=1;}}}if(!_2c){t._fireEvent(pid,_2b,_2d[pid],_2f);}}},_doMark:function(id,tp,_35,_36,_37){var i,ids,_38,_39,_3a,t=this,m=t.model,mm=m._model,_3b=t._byId[tp],_3c=t._last[tp],_3d=t._lazy[tp],_3e=_3b[id]||0,_3f;if(t._tree[tp]){_38=mm._call("children",[id]);if(_35==1&&_2.every(_38,function(_40){return (_3c[_40]||0)==(_3c[_38[0]]||0);})){_35=2;}}_3b[id]=_3c[id]=_35;if(!_37){t._fireEvent(id,tp,_35,_3e);}if(t._tree[tp]){ids=[id];while(ids.length){_39=ids.shift();_3e=_3b[_39]||0;_3f=_3b[_39]=_35==1?_3c[_39]||0:_35;if(!_37){t._fireEvent(_39,tp,_3f,_3e);}if(mm._call("hasChildren",[_39])){_38=mm._call("children",[_39]);if(_38.length){ids=ids.concat(_38);}else{_3d[_39]=_35;}}}if(!_36){_3a=mm._call("treePath",[id]);t._updateParents(_3a,tp,_37);}}}});});