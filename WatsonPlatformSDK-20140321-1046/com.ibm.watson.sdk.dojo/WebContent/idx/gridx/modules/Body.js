//>>built
define("idx/gridx/modules/Body",["dojo/_base/declare","dojo/_base/query","dojo/_base/array","dojo/_base/lang","dojo/_base/event","dojo/json","dojo/dom-construct","dojo/dom-class","dojo/_base/Deferred","dojo/_base/sniff","dojo/keys","../core/_Module","../core/util","dojo/i18n!../nls/Body"],function(_1,_2,_3,_4,_5,_6,_7,_8,_9,_a,_b,_c,_d,_e){return _1(_c,{name:"body",optional:["tree"],getAPIPath:function(){return {body:this};},constructor:function(){var t=this,m=t.model,g=t.grid,dn=t.domNode=g.bodyNode,_f=function(){t.refresh();};if(t.arg("rowHoverEffect")){_8.add(dn,"gridxBodyRowHoverEffect");}g.emptyNode.innerHTML=t.arg("loadingInfo",_e.loadingInfo);g._connectEvents(dn,"_onMouseEvent",t);t.aspect(m,"onSet","_onSet");t.aspect(g,"onRowMouseOver","_onRowMouseOver");t.aspect(g,"onCellMouseOver","_onCellMouseOver");t.aspect(g,"onCellMouseOut","_onCellMouseOver");t.connect(g.bodyNode,"onmouseleave",function(){_2("> .gridxRowOver",t.domNode).removeClass("gridxRowOver");});t.connect(g.bodyNode,"onmouseover",function(e){if(e.target==g.bodyNode){_2("> .gridxRowOver",t.domNode).removeClass("gridxRowOver");}});t.aspect(g,"setStore",_f);},preload:function(){this._initFocus();},load:function(_10){var t=this,m=t.model,g=t.grid,_11=function(){t.aspect(m,"onSizeChange","_onSizeChange");t.loaded.callback();};t.aspect(m,"onDelete","_onDelete");m.when({},function(){t.rootCount=t.rootCount||m.size();t.visualCount=g.tree?g.tree.getVisualSize(t.rootStart,t.rootCount):t.rootCount;_11();}).then(null,function(e){t._loadFail(e);_11();});},destroy:function(){this.inherited(arguments);this.domNode.innerHTML="";this._destroyed=true;},rowMixin:{node:function(){return this.grid.body.getRowNode({rowId:this.id});},visualIndex:function(){var t=this,id=t.id;return t.grid.body.getRowInfo({rowId:id,rowIndex:t.index(),parentId:t.model.parentId(id)}).visualIndex;}},cellMixin:{node:function(){return this.grid.body.getCellNode({rowId:this.row.id,colId:this.column.id});}},rowHoverEffect:true,stuffEmptyCell:true,renderWholeRowOnSet:false,compareOnSet:function(v1,v2){return typeof v1=="object"&&typeof v2=="object"?_6.stringify(v1)==_6.stringify(v2):v1===v2;},getRowNode:function(_12){if(this.model.isId(_12.rowId)&&_a("ie")){return this._getRowNode(_12.rowId);}else{var _13=this._getRowNodeQuery(_12);return _13&&_2("> "+_13,this.domNode)[0]||null;}},_getRowNode:function(id){for(var i=0,_14=this.domNode.childNodes,row;row=_14[i];++i){if(row.getAttribute("rowid")==id){return row;}}return null;},getCellNode:function(_15){var t=this,_16=_15.colId,_17=t.grid._columns,r=t._getRowNodeQuery(_15);if(r){if(!_16&&_17[_15.colIndex]){_16=_17[_15.colIndex].id;}var c=" [colid='"+_16+"'].gridxCell";if(t.model.isId(_15.rowId)&&_a("ie")){var _18=t._getRowNode(_15.rowId);return _2(c,_18)[0]||null;}else{return _2(r+c,t.domNode)[0]||null;}}return null;},getRowInfo:function(_19){var t=this,m=t.model,g=t.grid,id=_19.rowId;if(m.isId(id)){_19.rowIndex=m.idToIndex(id);_19.parentId=m.parentId(id);}if(typeof _19.rowIndex=="number"&&_19.rowIndex>=0){_19.visualIndex=g.tree?g.tree.getVisualIndexByRowInfo(_19.parentId,_19.rowIndex,t.rootStart):_19.rowIndex-t.rootStart;}else{if(typeof _19.visualIndex=="number"&&_19.visualIndex>=0){if(g.tree){var _1a=g.tree.getRowInfoByVisualIndex(_19.visualIndex,t.rootStart);_19.rowIndex=_1a.start;_19.parentId=_1a.parentId;}else{_19.rowIndex=t.rootStart+_19.visualIndex;}}else{return _19;}}_19.rowId=m.isId(id)?id:m.indexToId(_19.rowIndex,_19.parentId);return _19;},refresh:function(_1b){var t=this;delete t._err;return t.model.when({}).then(function(){var rs=t.renderStart,rc=t.renderCount;if(typeof _1b=="number"&&_1b>=0){_1b=rs>_1b?rs:_1b;var _1c=rs+rc-_1b,n=_2("> [visualindex=\""+_1b+"\"]",t.domNode)[0],_1d=[],_1e=[];if(n){var _1f=t._buildRows(_1b,_1c,_1d,_1e);if(_1f){_7.place(_1f,n,"before");}}while(n){var tmp=n.nextSibling,_20=parseInt(n.getAttribute("visualindex"),10),id=n.getAttribute("rowid");_7.destroy(n);if(_20>=_1b+_1c){t.onUnrender(id);}n=tmp;}_3.forEach(_1e,t.onAfterRow,t);_9.when(t._buildUncachedRows(_1d),function(){t.onRender(_1b,_1c);t.onForcedScroll();});}else{t.renderRows(rs,rc,0,1);t.onForcedScroll();}},function(e){t._loadFail(e);});},refreshCell:function(_21,_22){var d=new _9(),t=this,m=t.model,g=t.grid,col=g._columns[_22],_23=col&&t.getCellNode({visualIndex:_21,colId:col.id});if(_23){var _24,_25=t.getRowInfo({visualIndex:_21}),idx=_25.rowIndex,pid=_25.parentId;m.when({start:idx,count:1,parentId:pid},function(){_24=m.byIndex(idx,pid);if(_24){_25.rowId=m.indexToId(idx,pid);var _26=g.tree&&_24.data[col.id]===undefined;var _27=g.cell(_25.rowId,col.id,1);_23.innerHTML=t._buildCellContent(_27,_26);t.onAfterCell(_27);}}).then(function(){d.callback(!!_24);});return d;}d.callback(false);return d;},rootStart:0,rootCount:0,renderStart:0,renderCount:0,visualStart:0,visualCount:0,autoUpdate:true,autoChangeSize:true,updateRootRange:function(_28,_29){var t=this,_2a=t.grid.tree,vc=t.visualCount=_2a?_2a.getVisualSize(_28,_29):_29;t.rootStart=_28;t.rootCount=_29;if(t.renderStart+t.renderCount>vc){t.renderStart=vc-t.renderCount;if(t.renderStart<0){t.renderStart=0;t.renderCount=vc;}}if(!t.renderCount&&vc){t.onForcedScroll();}},renderRows:function(_2b,_2c,_2d,_2e){var t=this,g=t.grid,str="",_2f=[],_30=[],n=t.domNode,en=g.emptyNode,_31=t.arg("emptyInfo",_e.emptyInfo),_32="";if(t._err){return;}if(_2c>0){en.innerHTML=t.arg("loadingInfo",_e.loadingInfo);en.style.zIndex="";if(_2d!="top"&&_2d!="bottom"){t.model.free();}str=t._buildRows(_2b,_2c,_2f,_30);if(_2d=="top"){t.renderCount+=t.renderStart-_2b;t.renderStart=_2b;_7.place(str,n,"first");}else{if(_2d=="bottom"){t.renderCount=_2b+_2c-t.renderStart;_7.place(str,n,"last");}else{t.renderStart=_2b;t.renderCount=_2c;var _33=_2e?n.scrollTop:0;n.scrollTop=0;if(_a("ie")){while(n.childNodes.length){n.removeChild(n.firstChild);}}n.innerHTML=str;if(_33){n.scrollTop=_33;}n.scrollLeft=g.hScrollerNode.scrollLeft;_32=str?"":_31;if(!str){en.style.zIndex=1;}t.onUnrender();}}_3.forEach(_30,t.onAfterRow,t);_9.when(t._buildUncachedRows(_2f),function(){if(!t._err){en.innerHTML=_32;}t.onRender(_2b,_2c);});}else{if(!{top:1,bottom:1}[_2d]){n.scrollTop=0;if(_a("ie")){while(n.childNodes.length){n.removeChild(n.firstChild);}}n.innerHTML="";en.innerHTML=_31;en.style.zIndex=1;t.onUnrender();t.onEmpty();t.model.free();}}},unrenderRows:function(_34,_35){if(_34>0){var t=this,i=0,id,bn=t.domNode;if(_35=="post"){for(;i<_34&&bn.lastChild;++i){id=bn.lastChild.getAttribute("rowid");t.model.free(id);bn.removeChild(bn.lastChild);t.onUnrender(id);}}else{var tp=bn.scrollTop;for(;i<_34&&bn.firstChild;++i){id=bn.firstChild.getAttribute("rowid");t.model.free(id);tp-=bn.firstChild.offsetHeight;bn.removeChild(bn.firstChild);t.onUnrender(id);}t.renderStart+=i;bn.scrollTop=tp>0?tp:0;}t.renderCount-=i;t.model.when();}},onAfterRow:function(){},onAfterCell:function(){},onRender:function(){var bn=this.domNode;if(_a("ie")<9&&bn.childNodes.length){_2("> gridxLastRow",bn).removeClass("gridxLastRow");_8.add(bn.lastChild,"gridxLastRow");}},onUnrender:function(){},onDelete:function(){},onSet:function(){},onMoveToCell:function(){},onEmpty:function(){},onForcedScroll:function(){},collectCellWrapper:function(){},_getRowNodeQuery:function(_36){var r;if(this.model.isId(_36.rowId)){r="[rowid='"+_36.rowId+"']";}else{if(typeof _36.rowIndex=="number"&&_36.rowIndex>=0){r="[rowindex='"+_36.rowIndex+"']";if(_36.parentId){r+="[parentid='"+_36.parentId+"']";}}else{if(typeof _36.visualIndex=="number"&&_36.visualIndex>=0){r="[visualindex='"+_36.visualIndex+"']";}}}return r&&r+".gridxRow";},_buildRows:function(_37,_38,_39,_3a){var t=this,i,end=_37+_38,s=[],g=t.grid,m=t.model,w=t.domNode.scrollWidth;for(i=_37;i<end;++i){var _3b=t.getRowInfo({visualIndex:i}),row=g.row(_3b.rowId,1);s.push("<div class=\"gridxRow ",i%2?"gridxRowOdd":"","\" role=\"row\" visualindex=\"",i);if(row){m.keep(row.id);s.push("\" rowid=\"",row.id,"\" rowindex=\"",_3b.rowIndex,"\" parentid=\"",_3b.parentId,"\">",t._buildCells(row),"</div>");_3a.push(row);}else{s.push("\"><div class=\"gridxRowDummy\" style=\"width:",w,"px;\"></div></div>");_3b.start=_3b.rowIndex;_3b.count=1;_39.push(_3b);}}return s.join("");},_buildUncachedRows:function(_3c){var t=this;return _3c.length&&t.model.when(_3c,function(){try{_3.forEach(_3c,t._buildRowContent,t);}catch(e){t._loadFail(e);}}).then(null,function(e){t._loadFail(e);});},_loadFail:function(e){console.error(e);var en=this.grid.emptyNode;en.innerHTML=this.arg("loadFailInfo",_e.loadFailInfo);en.style.zIndex=1;this.domNode.innerHTML="";this._err=e;},_buildRowContent:function(_3d){var t=this,n=_2("> [visualindex=\""+_3d.visualIndex+"\"]",t.domNode)[0];if(n){var row=t.grid.row(_3d.rowIndex,0,_3d.parentId);if(row){t.model.keep(row.id);n.setAttribute("rowid",row.id);n.setAttribute("rowindex",_3d.rowIndex);n.setAttribute("parentid",_3d.parentId||"");n.innerHTML=t._buildCells(row);t.onAfterRow(row);}else{throw new Error("Row is not in cache:"+_3d.rowIndex);}}},_buildCells:function(row){var col,_3e,_3f,cls,_40,i,len,t=this,g=t.grid,_41=g._columns,_42=row.data(),_43=g.focus&&(g.focus.currentArea()=="body"),sb=["<table class=\"gridxRowTable\" role=\"presentation\" border=\"0\" cellpadding=\"0\" cellspacing=\"0\"><tr>"];for(i=0,len=_41.length;i<len;++i){col=_41[i];_3f=g.tree&&_42[col.id]===undefined;_3e=g.cell(row.id,col.id,1);cls=(_4.isFunction(col["class"])?col["class"](_3e):col["class"])||"";_40=g.bidi?g.bidi.getTextDirStyle(col.id,_3e.data()):"";_40+=(_4.isFunction(col.style)?col.style(_3e):col.style)||"";sb.push("<td aria-describedby=\"",(g.id+"-"+col.id).replace(/\s+/,""),"\" class=\"gridxCell ");if(_3f){sb.push("gridxPaddingCell");}if(_43&&t._focusCellRow===row.visualIndex()&&t._focusCellCol===i){sb.push("gridxCellFocus");}sb.push(cls,"\" aria-readonly=\"true\" role=\"gridcell\" tabindex=\"-1\" colid=\"",col.id,"\" style=\"width: ",col.width,"; ",_40,"\">",t._buildCellContent(_3e,_3f),"</td>");}sb.push("</tr></table>");return sb.join("");},_buildCellContent:function(_44,_45){var r="",col=_44.column,row=_44.row,_46=_44.data();if(!_45){var s=col.decorator?col.decorator(_46,row.id,row.visualIndex()):_46;r=this._wrapCellData(s,row.id,col.id);}return (r===""||r===null||r===undefined)&&(_a("ie")<8||this.arg("stuffEmptyCell"))?"&nbsp;":r;},_wrapCellData:function(_47,_48,_49){var _4a=[];this.collectCellWrapper(_4a,_48,_49);var i=_4a.length-1;if(i>0){_4a.sort(function(a,b){a.priority=a.priority||0;b.priority=b.priority||0;return a.priority-b.priority;});}for(;i>=0;--i){_47=_4a[i].wrap(_47,_48,_49);}return _47;},_onMouseEvent:function(_4b,e){var g=this.grid,_4c="onCell"+_4b,_4d="onRow"+_4b;if(g._isConnected(_4c)||g._isConnected(_4d)){this._decorateEvent(e);if(e.rowId){if(e.columnId){g[_4c](e);}g[_4d](e);}}},_decorateEvent:function(e){var n=e.target||e.originalTarget,g=this.grid,tag;for(;n&&n!=g.bodyNode;n=n.parentNode){tag=n.tagName&&n.tagName.toLowerCase();if(tag=="td"&&_8.contains(n,"gridxCell")){var col=g._columnsById[n.getAttribute("colid")];e.cellNode=n;e.columnId=col.id;e.columnIndex=col.index;}if(tag=="div"&&_8.contains(n,"gridxRow")){e.rowId=n.getAttribute("rowid");e.parentId=n.getAttribute("parentid");e.rowIndex=parseInt(n.getAttribute("rowindex"),10);e.visualIndex=parseInt(n.getAttribute("visualindex"),10);return;}}},_onSet:function(id,_4e,_4f,_50){var t=this;if(t.autoUpdate&&_4f){var g=t.grid,row=g.row(id,1),_51=row&&row.node();if(_51){var _52=_4f.data,_53=_50.data,_54=g._columns,_55=t.arg("renderWholeRowOnSet"),_56=t.arg("compareOnSet");if(_55){_51.innerHTML=t._buildCells(row);t.onAfterRow(row);t.onSet(row);t.onRender(_4e,1);}else{_3.forEach(_54,function(col){if(!_56(_52[col.id],_53[col.id])){var _57=g.tree&&_52[col.id]===undefined,_58=row.cell(col.id,1);_58.node().innerHTML=t._buildCellContent(_58,_57);t.onAfterCell(_58);}});}}}},_onDelete:function(id){var t=this;if(t.autoUpdate){var _59=t.getRowNode({rowId:id});if(_59){var sn,_5a=0,_5b=parseInt(_59.getAttribute("rowindex"),10),pid=_59.getAttribute("parentid"),_5c={},_5d=[_59],rid,ids=[id],_5e;_5c[id]=1;for(sn=_59.nextSibling;sn&&_5c[sn.getAttribute("parentid")];sn=sn.nextSibling){rid=sn.getAttribute("rowid");ids.push(rid);_5d.push(sn);_5c[rid]=1;}for(;sn;sn=sn.nextSibling){if(sn.getAttribute("parentid")==pid){sn.setAttribute("rowindex",parseInt(sn.getAttribute("rowindex"),10)-1);}_5e=parseInt(sn.getAttribute("visualindex"),10)-_5d.length;sn.setAttribute("visualindex",_5e);_8.toggle(sn,"gridxRowOdd",_5e%2);++_5a;}t.renderCount-=_5d.length;_3.forEach(_5d,_7.destroy);_3.forEach(ids,t.onUnrender,t);if(t.rootStart+t.rootCount>=t.model.size()){if(pid===""){t.updateRootRange(t.rootStart,t.rootCount-1);}else{t.visualCount=t.grid.tree?t.grid.tree.getVisualSize(t.rootStart,t.rootCount):t.rootCount;}}t.onDelete(id,_5b);t.onRender(_5b,_5a);if(!t.domNode.childNodes.length){var en=t.grid.emptyNode,_5f=t.arg("emptyInfo",_e.emptyInfo);en.innerHTML=_5f;en.style.zIndex=1;t.onEmpty();}}}},_onSizeChange:function(_60,_61){var t=this;if(t.autoChangeSize&&t.rootStart===0&&(t.rootCount===_61||_61<0)){t.updateRootRange(0,_60);if(t._sizeChangeHandler){clearTimeout(t._sizeChangeHandler);}t._sizeChangeHandler=setTimeout(function(){if(!t._destroyed){t.refresh();}},10);}},_onRowMouseOver:function(e){var _62=_2("> div.gridxRowOver",this.domNode)[0],_63=this.getRowNode({rowId:e.rowId});if(_62!=_63){if(_62){_8.remove(_62,"gridxRowOver");}if(_63){_8.add(_63,"gridxRowOver");}}},_onCellMouseOver:function(e){_8.toggle(e.cellNode,"gridxCellOver",e.type=="mouseover");},_focusCellCol:0,_focusCellRow:0,_initFocus:function(){var t=this,g=t.grid,ltr=g.isLeftToRight(),bn=g.bodyNode,_64=g.focus,c="connect";if(_64){_64.registerArea({name:"body",priority:1,focusNode:bn,scope:t,doFocus:t._doFocus,doBlur:t._blurCell,onFocus:t._onFocus,onBlur:t._blurCell});t[c](g.mainNode,"onkeypress",function(evt){if(_64.currentArea()=="body"){var dk=_b;if(evt.keyCode==dk.HOME&&!evt.ctrlKey){t._focusCellCol=0;t._focusCell();_5.stop(evt);}else{if(evt.keyCode==dk.END&&!evt.ctrlKey){t._focusCellCol=g._columns.length-1;t._focusCell();_5.stop(evt);}else{if(!g.tree||!evt.ctrlKey){_64._noBlur=1;var arr={},dir=ltr?1:-1;arr[dk.LEFT_ARROW]=[0,-dir,evt];arr[dk.RIGHT_ARROW]=[0,dir,evt];arr[dk.UP_ARROW]=[-1,0,evt];arr[dk.DOWN_ARROW]=[1,0,evt];t._moveFocus.apply(t,arr[evt.keyCode]||[]);_64._noBlur=0;}}}}});t[c](g,"onCellClick",function(evt){t._focusCellRow=evt.visualIndex;t._focusCellCol=evt.columnIndex;});t[c](t,"onRender",function(_65,_66){if(t._focusCellRow>=_65&&t._focusCellRow<_65+_66&&_64.currentArea()=="body"){t._focusCell();}});t[c](g.emptyNode,"onfocus",function(){_64.focusArea("body");});}},_doFocus:function(evt){return this._focusCell(evt)||this._focusCell(0,-1,-1);},_focusCell:function(evt,_67,_68){var t=this,g=t.grid;g.focus.stopEvent(evt);_68=_68>=0?_68:t._focusCellCol;_67=_67>=0?_67:t._focusCellRow;var _69=g._columns[_68].id,n=t.getCellNode({visualIndex:_67,colId:_69});if(n){var _6a=_2(".gridxCellFocus",t.domNode)[0];if(n!=_6a){if(_6a){_8.remove(_6a,"gridxCellFocus");}_8.add(n,"gridxCellFocus");t._focusCellRow=_67;t._focusCellCol=_68;g.header._focusHeaderId=_69;}g.hScroller.scrollToColumn(_69);if(_a("ie")<8){var _6b=g.bodyNode.scrollLeft;n.focus();g.bodyNode.scrollLeft=_6b;}else{n.focus();}}else{if(!g.rowCount()){g.emptyNode.focus();return true;}}return n;},_moveFocus:function(_6c,_6d,evt){if(_6c||_6d){var r,c,t=this,g=t.grid,_6e=g._columns,vc=t.visualCount;g.focus.stopEvent(evt);r=t._focusCellRow+_6c;r=r<0?0:(r>=vc?vc-1:r);c=t._focusCellCol+_6d;c=c<0?0:(c>=_6e.length?_6e.length-1:c);g.vScroller.scrollToRow(r).then(function(){t._focusCell(0,r,c);t.onMoveToCell(r,c,evt);});}},_nextCell:function(r,c,dir,_6f){var d=new _9(),g=this.grid,cc=g._columns.length,rc=this.visualCount;do{c+=dir;if(c<0||c>=cc){r+=dir;c=c<0?cc-1:0;if(r<0){r=rc-1;c=cc-1;}else{if(r>=rc){r=0;c=0;}}}}while(!_6f(r,c));g.vScroller.scrollToRow(r).then(function(){g.hScroller.scrollToColumn(g._columns[c].id);d.callback({r:r,c:c});});return d;},_blurCell:function(){var n=_2(".gridxCellFocus",this.domNode)[0];if(n){_8.remove(n,"gridxCellFocus");}return true;},_onFocus:function(evt){for(var n=evt.target,t=this;n&&n!=t.domNode;n=n.parentNode){if(_8.contains(n,"gridxCell")){var _70=t.grid._columnsById[n.getAttribute("colid")].index;while(!_8.contains(n,"gridxRow")){n=n.parentNode;}return t._focusCell(0,parseInt(n.getAttribute("visualindex"),10),_70);}}return false;}});});