//>>built
define("idx/gridx/modules/Tree",["dojo/_base/kernel","dojo/_base/declare","dojo/_base/array","dojo/dom-class","dojo/dom-geometry","dojo/_base/lang","dojo/_base/Deferred","dojo/DeferredList","dojo/query","dojo/keys","../core/util","../core/_Module"],function(_1,_2,_3,_4,_5,_6,_7,_8,_9,_a,_b,_c){_1.experimental("gridx/modules/Tree");function _d(_e){var n=_e.firstChild;return n&&n.className&&_4.contains(n,"gridxTreeExpandoCell")&&!_4.contains(n,"gridxTreeExpandoLoading");};return _2(_c,{name:"tree",constructor:function(){this._clear();},getAPIPath:function(){return {tree:this};},preload:function(){var t=this,g=t.grid;if(t.model.treeMarkMode){t.model.treeMarkMode("",true);}g.domNode.setAttribute("role","treegrid");t.batchConnect([g.body,"collectCellWrapper","_createCellWrapper"],[g.body,"onAfterRow","_onAfterRow"],[t.model,"onDelete","_onDelete"],[g,"onCellClick","_onCellClick"],[g,"setStore","_clear"]);t._initExpandLevel();t._initFocus();if(g.persist){var id,_f=g.persist.registerAndLoad("tree",function(){return {openInfo:t._openInfo,parentOpenInfo:t._parentOpenInfo};});if(_f&&_f.openInfo&&_f.parentOpenInfo){var _10=t._openInfo=_f.openInfo,_11=t._parentOpenInfo=_f.parentOpenInfo;for(id in _10){_10[id].openned=_11[id];}t._persisted=1;}}},load:function(_12){var t=this;if(t._persisted){t.loaded.callback();}else{t.model.when({},function(){t._openInfo[""].count=t.model.size();}).then(function(){t.loaded.callback();});}},rowMixin:{canExpand:function(){return this.grid.tree.canExpand(this.id);},isExpanded:function(){return this.grid.tree.isExpanded(this.id);},expand:function(){return this.grid.tree.expand(this.id);},collapse:function(){return this.grid.tree.collapse(this.id);},expandRecursive:function(){return this.grid.expandRecursive(this.id);},collapseRecursive:function(){return this.grid.collapseRecursive(this.id);}},nested:false,expandoPadding:18,expandLevel:1/0,onExpand:function(id){},onCollapse:function(id){},canExpand:function(id){var t=this,m=t.model,_13=m.treePath(id).length,_14=t.arg("expandLevel");return m.hasChildren(id)&&(!(_14>0)||_13<=_14);},isExpanded:function(id){return !!this._openInfo[id];},expand:function(id,_15){var d=new _7(),t=this;if(id&&!t.isExpanded(id)){t._beginLoading(id);t.model.when({parentId:id,start:0},function(){t._logicExpand(id);}).then(function(){_7.when(t._updateBody(id,_15,true),function(){t._endLoading(id);d.callback();t.onExpand(id);});});}else{d.callback();}return d;},collapse:function(id,_16){var d=new _7(),t=this;if(id&&t.isExpanded(id)){t._logicCollapse(id);_7.when(t._updateBody(id,_16),function(){d.callback();t.onCollapse(id);});}else{d.callback();}return d;},expandRecursive:function(id,_17){var t=this,m=t.model,d=new _7();t._beginLoading(id);t.expand(id,1).then(function(){var i,dl=[],_18=m.size(id);m.when({start:0,parentId:id},function(){for(i=0;i<_18;++i){var _19=m.indexToId(i,id);dl.push(t.expandRecursive(_19,1));}}).then(function(){new _8(dl).then(function(){_7.when(t._updateBody(id,_17),function(){t._endLoading(id);d.callback();});});});});return d;},collapseRecursive:function(id,_1a){var d=new _7(),_1b=_6.hitch(d,d.callback),_1c=_6.hitch(d,d.errback),t=this,_1d=t._openInfo[id||""],i,dl=[];if(_1d){for(i=_1d.openned.length-1;i>=0;--i){dl.push(t.collapseRecursive(_1d.openned[i],1));}new _8(dl).then(function(){if(id){t.collapse(id,_1a).then(_1b,_1c);}else{_7.when(t._updateBody("",_1a),_1b,_1c);}});}else{_1b();}return d;},refresh:function(){var t=this,m=t.model,d=new _7(),_1e=_6.hitch(d,d.callback),_1f=_6.hitch(d,d.errback),id,ids=[],_20=[],_21=t.grid.body;for(id in t._openInfo){if(m.isId(id)){ids.push(id);_20.push({parentId:id,start:0});}}t._clear();m.when(_20,function(){var _22=t._openInfo[""].count=m.size();_3.forEach(ids,t._logicExpand,t);_21.visualCount=t.getVisualSize(0,_22);}).then(function(){_21.refresh().then(_1e,_1f);},_1f);return d;},getRowInfoByVisualIndex:function(_23,_24){var t=this,_25=t._openInfo[""].openned,_26,i;_23+=_24;for(i=0;i<_25.length;++i){_26=t._openInfo[_25[i]];if(_26.index<_24){_23+=_26.count;}else{break;}}var _27={parentId:"",preCount:0};while(!_27.found){_27=t._getChild(_23,_27);}return _27;},getVisualIndexByRowInfo:function(_28,_29,_2a){var _2b=this._getAbsoluteVisualIndex(_28,_29);return _2b>=0?_2b-this._getAbsoluteVisualIndex("",_2a):null;},getVisualSize:function(_2c,_2d,_2e){var _2f=this._openInfo[_2e||""];if(_2f){var i,len=_2f.openned.length,_30,_31=_2d;for(i=0;i<len;++i){_30=this._openInfo[_2f.openned[i]];if(_30.index>=_2c&&_30.index<_2c+_2d){_31+=_30.count;}}return _31;}return 0;},_clear:function(){var _32=[];this._openInfo={"":{id:"",parentId:null,index:-1,count:0,openned:_32}};this._parentOpenInfo={"":_32};},_initExpandLevel:function(){var _33=this.grid._columns;if(!_3.some(_33,function(col){return col.expandLevel;})){if(this.arg("nested")){_3.forEach(_33,function(col,i){col.expandLevel=i+1;});}else{_33[0].expandLevel=1;}}},_createCellWrapper:function(_34,_35,_36){var t=this,col=t.grid._columnsById[_36];if(col.expandLevel){var _37=t.arg("nested"),_38=t.model.treePath(_35).length,_39=t.arg("expandLevel");if((!_37||col.expandLevel==_38)&&(!(_39>0)||_38<=_39+1)){var _3a=t.model.hasChildren(_35),_3b=t.isExpanded(_35),pad=0,_3c=t.arg("expandoPadding"),ltr=t.grid.isLeftToRight();if(!_37){pad=(_38-1)*_3c;}if(_38==_39+1){if(_37){return;}_3a=false;}_34.push({priority:0,wrap:function(_3d){return ["<div class='gridxTreeExpandoCell ",_3b?"gridxTreeExpandoCellOpen":"","' style='padding-",ltr?"left":"right",": ",pad+_3c,"px;'>","<span class='gridxTreeExpandoIcon ",_3a?"":"gridxTreeExpandoIconNoChildren","' ","style='margin-",ltr?"left":"right",": ",pad,"px;'>","<span class='gridxTreeExpandoInner'>",_3b?"-":"+","</span></span><span class='gridxTreeExpandoContent'>",_3d,"</span></span>"].join("");}});}}},_onCellClick:function(e){if(_d(e.cellNode)){var t=this,pos=_5.position(_9(".gridxTreeExpandoIcon",e.cellNode)[0]);if(e.clientX>=pos.x&&e.clientX<=pos.x+pos.w&&e.clientY>=pos.y&&e.clientY<=pos.y+pos.h){if(t.isExpanded(e.rowId)){t.collapse(e.rowId);}else{t.expand(e.rowId);}}}},_beginLoading:function(id){var _3e=this.grid.body,_3f=_3e.getRowNode({rowId:id});if(_3f){var n=_9(".gridxTreeExpandoCell",_3f)[0];if(n){var _40=_9(".gridxTreeExpandoIcon",n)[0];_40.firstChild.innerHTML="o";_4.add(n,"gridxTreeExpandoLoading");}}},_endLoading:function(id){var _41=this.grid.body,_42=_41.getRowNode({rowId:id}),_43=this.isExpanded(id);if(_42){var n=_9(".gridxTreeExpandoCell",_42)[0];if(n){var _44=_9(".gridxTreeExpandoIcon",n)[0];_42.setAttribute("aria-expanded",_43?"true":"false");_44.firstChild.innerHTML=_43?"-":"+";_4.remove(n,"gridxTreeExpandoLoading");_4.toggle(n,"gridxTreeExpandoCellOpen",_43);}}},_updateBody:function(id,_45,_46){var t=this,_47=t.grid.body;_47.updateRootRange(_47.rootStart,_47.rootCount);if(!_45){var _48=_46&&id?t.getVisualIndexByRowInfo(t.model.treePath(id).pop(),t.model.idToIndex(id),_47.rootStart):-1;return _47.refresh(_46&&_48+1);}return null;},_getAbsoluteVisualIndex:function(_49,_4a){var _4b=this._openInfo[_49||""];if(_4b){var _4c=0,_4d=this._openInfo,_4e=function(_4f){_4c+=_4a;var _50,i;for(i=0;i<_4f.openned.length;++i){_50=_4d[_4f.openned[i]];if(_50.index<_4a){_4c+=_50.count;}else{break;}}_4a=_4f.index;if(_4f.id){_4c++;}return _4d[_4f.parentId];};while(_4b){_4b=_4e(_4b);}return _4c;}return -1;},_logicExpand:function(id){var t=this,m=t.model,_51=m.treePath(id),_52=_51.length,_53=t.arg("expandLevel");if(m.hasChildren(id)&&(!(_53>0)||_52<=_53)){var _54=_51.pop(),_55=t._openInfo,poi=t._parentOpenInfo,_56=poi[_54]=poi[_54]||[];poi[id]=poi[id]||[];if(!_55[id]){var _57=m.idToIndex(id);if(_57>=0){var _58=m.size(id),i=_b.biSearch(_56,function(_59){return _55[_59].index-_57;});if(_56[i]!==id){_56.splice(i,0,id);}for(i=poi[id].length-1;i>=0;--i){_58+=_55[poi[id][i]].count;}_55[id]={id:id,parentId:_54,index:_57,count:_58,openned:poi[id]};var _5a=_55[_54];while(_5a){_5a.count+=_58;_5a=_55[_5a.parentId];}}}}},_logicCollapse:function(id){var t=this,_5b=t._openInfo[id];if(_5b){var _5c=t._openInfo,_5d=t.model.treePath(id).pop(),_5e=t._parentOpenInfo[_5d],i=_b.biSearch(_5e,function(_5f){return _5c[_5f].index-_5b.index;}),_60=_5b.count;_5e.splice(i,1);_5b=_5c[_5d];while(_5b){_5b.count-=_60;_5b=_5c[_5b.parentId];}delete _5c[id];}},_getChild:function(_61,_62){var _63=this._openInfo[_62.parentId],i,len,_64=_62.preCount+_63.index+1,_65={found:true,visualIndex:_61,count:1};for(i=0,len=_63.openned.length;i<len;++i){var _66=_63.openned[i],_67=this._openInfo[_66],_68=_67.index+_64;if(_68===_61){return _6.mixin({parentId:_63.id,start:_67.index},_65);}else{if(_68>_61){break;}else{if(_68+_67.count>=_61){return {parentId:_66,preCount:_64};}}}_64+=_67.count;}return _6.mixin({parentId:_63.id,start:_61-_64},_65);},_onAfterRow:function(row){var _69=this.model.hasChildren(row.id);if(_69){row.node().setAttribute("aria-expanded",this.isExpanded(row.id));}},_onDelete:function(_6a,_6b,_6c){var _6d=this._openInfo,_6e=this._parentOpenInfo,_6f=_6d[_6a],_70=this.model,_71=_6c.pop(),_72=1,_73=function(id,_74){var _75=_6d[id],_76=_6e[id]||[];_3.forEach(_76,function(_77){_73(_77);});delete _6e[id];if(_75){delete _6d[id];_74=_75.parentId;}else{if(!_70.isId(_74)){return;}}var _78=_6e[_74],i=_3.indexOf(_78,id);if(i>=0){_78.splice(i,1);for(;i<_78.length;++i){_6d[_78[i]].index--;}}else{var _79=_75?_75.index:_6b;for(i=0;i<_78.length;++i){_75=_6d[_78[i]];if(_75.index>_79){_75.index--;}}}};if(_6f){_72+=_6f.count;_6f=_6d[_6f.parentId];}else{if(this.model.isId(_71)){_6f=_6d[_71];}}_73(_6a,_71);while(_6f){_6f.count-=_72;_6f=_6d[_6f.parentId];}},_initFocus:function(){this.connect(this.grid,"onCellKeyPress","_onKey");},_onKey:function(e){var t=this;if(e.keyCode==_a.ESCAPE){var m=t.model,_7a=m.treePath(e.rowId),_7b=_7a.pop(),_7c=_7a.length,_7d=t.grid;if(_7b){var i,col,_7e;for(i=_7d._columns.length-1;i>=0;--i){col=_7d._columns[i];if(col.expandLevel&&(!t.arg("nested")||col.expandLevel==_7c)){break;}}m.when({id:_7b},function(){_7e=_7d.body.getVisualIndex({parentId:_7a.pop(),rowIndex:m.idToIndex(_7b)}).visualIndex;}).then(function(){_7d.vScroller.scrollToRow(_7e).then(function(){_7d.body._focusCell(null,_7e,col.index);});});}}else{if(e.ctrlKey&&_d(e.cellNode)){var ltr=t.grid.isLeftToRight();if(e.keyCode==(ltr?_a.LEFT_ARROW:_a.RIGHT_ARROW)&&t._openInfo[e.rowId]){t.collapse(e.rowId);}else{if(e.keyCode==(ltr?_a.RIGHT_ARROW:_a.LEFT_ARROW)&&!t._openInfo[e.rowId]){t.expand(e.rowId);}}}}}});});