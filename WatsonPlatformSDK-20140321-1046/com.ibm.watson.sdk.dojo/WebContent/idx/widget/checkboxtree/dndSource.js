//>>built
define("idx/widget/checkboxtree/dndSource",["dojo/_base/declare","dojo/_base/connect","dojo/_base/array","dojo/_base/lang","dojo/_base/event","idx/dnd/Manager","dojo/mouse","dojo/dom-class","dojo/dom-geometry","./_dndSelector"],function(_1,_2,_3,_4,_5,_6,_7,_8,_9,_a){return _1("idx.widget.checkboxtree.dndSource",_a,{isSource:true,accept:["text","treeNode"],copyOnly:false,dragThreshold:5,betweenThreshold:0,constructor:function(_b,_c){if(!_c){_c={};}_4.mixin(this,_c);this.isSource=typeof _c.isSource=="undefined"?true:_c.isSource;var _d=_c.accept instanceof Array?_c.accept:["text","treeNode"];this.accept=null;if(_d.length){this.accept={};for(var i=0;i<_d.length;++i){this.accept[_d[i]]=1;}}this.isDragging=false;this.mouseDown=false;this.targetAnchor=null;this.targetBox=null;this.dropPosition="";this._lastX=0;this._lastY=0;this.sourceState="";if(this.isSource){_8.add(this.node,"dojoDndSource");}this.targetState="";if(this.accept){_8.add(this.node,"dojoDndTarget");}this.topics=[_2.subscribe("/dnd/source/over",this,"onDndSourceOver"),_2.subscribe("/dnd/start",this,"onDndStart"),_2.subscribe("/dnd/drop",this,"onDndDrop"),_2.subscribe("/dnd/cancel",this,"onDndCancel")];},checkAcceptance:function(_e,_f){return true;},copyState:function(_10){return this.copyOnly||_10;},destroy:function(){this.inherited("destroy",arguments);_3.forEach(this.topics,_2.unsubscribe);this.targetAnchor=null;},_onDragMouse:function(e){var m=_6.manager(),_11=this.targetAnchor,_12=this.current,_13=this.dropPosition;var _14=false;if(m.source.tree.model instanceof dijit.tree.ForestStoreModel){var _15=m.source.tree.rootNode.getChildren();for(var i=0;i<_15.length;i++){if(_15[i].id in m.source.selection){_14=true;break;}}}else{if(m.source.tree.rootNode.id in m.source.selection){_14=true;}}var _16="Over";if(!_14&&_12){if(_12&&this.betweenThreshold>0){if(!this.targetBox||_11!=_12){this.targetBox=_9.position(_12.rowNode,true);}if((e.pageY-this.targetBox.y)<=this.betweenThreshold){_16="Before";}else{if((e.pageY-this.targetBox.y)>=(this.targetBox.h-this.betweenThreshold)){_16="After";}}}if(_12!=_11||_16!=_13){if(_11){this._removeItemClass(_11.rowNode,_13);}if(_12){this._addItemClass(_12.rowNode,_16);}if(!_12){m.canDrop(false);}else{if((_12==this.tree.rootNode||(this.tree.model instanceof dijit.tree.ForestStoreModel&&_12.getParent()==this.tree.rootNode))&&_16!="Over"){m.canDrop(false);}else{if(m.source==this&&(_12.id in this.selection)){m.canDrop(false);}else{if(this.checkItemAcceptance(_12.rowNode,m.source,_16.toLowerCase())&&!this._isParentChildDrop(m.source,_12.rowNode)){var _17=true;for(var x in m.source.selection){if(m.source.selection[x].item==_12.item){_17=false;break;}}m.canDrop(_17);}else{m.canDrop(false);}}}}this.targetAnchor=_12;this.dropPosition=_16;}}else{m.canDrop(false);}},onMouseMove:function(e){if(this.isDragging&&this.targetState=="Disabled"){return;}var m=_6.manager();if(this.isDragging){this._onDragMouse(e);}else{if(this.mouseDown&&this.isSource&&(Math.abs(e.pageX-this._lastX)>=this.dragThreshold||Math.abs(e.pageY-this._lastY)>=this.dragThreshold)){var _18=this.getSelectedTreeNodes();if(_18.length&&!(_18.length==1&&_18[0].checkboxNode.checked===false)){if(_18.length>1){var _19=this.selection,i=0,r=[],n,p;nextitem:while((n=_18[i++])){for(p=n.getParent();p&&p!==this.tree;p=p.getParent()){if(_19[p.id]){continue nextitem;}}r.push(n);}_18=r;}_18=_3.map(_18,function(n){return n.domNode;});m.startDrag(this,_18,this.copyState(_2.isCopyKey(e)));}else{this.isDirectDnD=true;this.setSelection([this.candidateNode]);m.startDrag(this,[this.candidateNode.domNode],this.copyState(_2.isCopyKey(e)));}}}},onMouseDown:function(e){this.mouseDown=true;this.mouseButton=e.button;this._lastX=e.pageX;this._lastY=e.pageY;_5.stop(e);this.inherited(arguments);},onMouseUp:function(e){if(this.mouseDown){this.mouseDown=false;this.inherited(arguments);}},onMouseOut:function(){this.inherited(arguments);this._unmarkTargetAnchor();},checkItemAcceptance:function(_1a,_1b,_1c){return true;},onDndSourceOver:function(_1d){if(this!=_1d){this.mouseDown=false;this._unmarkTargetAnchor();}else{if(this.isDragging){var m=_6.manager();m.canDrop(false);}}},onDndStart:function(_1e,_1f,_20){if(this.isSource){this._changeState("Source",this==_1e?(_20?"Copied":"Moved"):"");}var _21=this.checkAcceptance(_1e,_1f);this._changeState("Target",_21?"":"Disabled");if(this==_1e){_6.manager().overSource(this);}this.isDragging=true;},itemCreator:function(_22,_23,_24){var _25=function(_26){var _27=dijit.byNode(_26).item;var _28=_23.tree.model.store;var _29=_28.getIdentityAttributes(_27);var _2a={};var _2b="id";for(var i=_29.length-1;i>=0;--i){_2a[_29[i]]=_28.getValue(_27,_29[i]);_2b=_29[i];}var _2c=function(i){_2a[_2b]=_28.getValue(_27,_2b)+(new Date()).getTime();};_28.fetchItemByIdentity({identity:_2b,onItem:_2c,scope:this});_2a["name"]=_28.getValue(_27,"name");return _2a;};return _3.map(_22,_25,this);},onDndDrop:function(_2d,_2e,_2f){if(this.containerState=="Over"){var _30=this.tree,_31=_30.model,_32=this.targetAnchor,_33=false;this.isDragging=false;var _34=_32;var _35;var _36;_35=(_34&&_34.item)||_30.item;if(this.dropPosition=="Before"||this.dropPosition=="After"){_35=(_34.getParent()&&_34.getParent().item)||_30.item;_36=_34.getIndexInParent();if(this.dropPosition=="After"){_36=_34.getIndexInParent()+1;}}else{_35=(_34&&_34.item)||_30.item;}var _37;var _38=function(_39,_3a,_3b,_3c,_3d){var _3e=dijit.byNode(_39);var _3f=_3d.itemCreator([_39],_2d,_31.store);_31.newItem(_3f[0],_3a,_3b);_3d.tree.toggleNode(_3f[0].id,_3c);var _40=_3e.getChildren();_3.forEach(_40,function(_41,idx){_3d.tree.model.store.fetchItemByIdentity({identity:_3f[0].id,onItem:_4.hitch(_3d,function(_42){_38(_41.domNode,_42,idx,_3c,this);})});},this);};var _43=function(_44){var _45=_44.getChildren();_3.forEach(_45,function(_46,idx){_43(_46);},this);if(_2d.selection[_44.id]){_2d.removeTreeNode(_44);}_2d.tree.model.store.deleteItem(_44.item);};_3.forEach(_2e,function(_47,idx){var _48=_2d.getItem(_47.id);if(_3.indexOf(_48.type,"treeNode")!=-1){var _49=_48.data,_4a=_49.item,_4b=_49.getParent().item;}var _4c=_49.checkboxNode.checked;var _4d=_49.getParent();var _4e=_4d.getChildren();if(_31.isItem(_4a)){if(_2d==this){if(typeof _36=="number"){if(_35==_4b&&_49.getIndexInParent()<_36){_36-=1;}}}if(_2f){_38(_47,_35,_36,_4c,this);}else{_31.pasteItem(_4a,_4b,_35,_2f,_36);}this.tree.toggleNode(_4a.id[0],_4c);}else{_38(_47,_35,_36,_4c,this);if(!_2f){var _4f=dijit.byNode(_47);_43(_4f);_2d.tree.model.store.save();}}},this);this.tree._expandNode(_34);}this.onDndCancel();},onDndCancel:function(){this._unmarkTargetAnchor();this.isDragging=false;this.mouseDown=false;delete this.mouseButton;this._changeState("Source","");this._changeState("Target","");if(this.isDirectDnD==true){this.isDirectDnD=false;}},onOverEvent:function(){this.inherited(arguments);_6.manager().overSource(this);},onOutEvent:function(){this._unmarkTargetAnchor();var m=_6.manager();if(this.isDragging){m.canDrop(false);}m.outSource(this);this.inherited(arguments);},_isParentChildDrop:function(_50,_51){if(!_50.tree||_50.tree!=this.tree){return false;}var _52=_50.tree.domNode;var ids=_50.selection;var _53=_51.parentNode;while(_53!=_52&&!ids[_53.id]){_53=_53.parentNode;}return _53.id&&ids[_53.id];},_unmarkTargetAnchor:function(){if(!this.targetAnchor){return;}this._removeItemClass(this.targetAnchor.rowNode,this.dropPosition);this.targetAnchor=null;this.targetBox=null;this.dropPosition=null;},_markDndStatus:function(_54){this._changeState("Source",_54?"Copied":"Moved");}});});